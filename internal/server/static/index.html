<!doctype html>
<html
    lang="en"
    data-color-mode="auto"
    data-light-theme="light"
    data-dark-theme="dark"
>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guck - Git Diff Reviewer</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css"
        />
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
            id="hljs-light"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
            id="hljs-dark"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <style>
            /* GitHub Diff Colors - Light Mode */
            :root {
                --diffBlob-additionLine-bgColor: #dafbe1;
                --diffBlob-additionNum-bgColor: #aceebb;
                --diffBlob-additionWord-bgColor: #aceebb;
                --diffBlob-deletionLine-bgColor: #ffebe9;
                --diffBlob-deletionNum-bgColor: #ffcecb;
                --diffBlob-deletionWord-bgColor: #ffcecb;
                --diffBlob-addition-fgColor: #116329;
                --diffBlob-deletion-fgColor: #82071e;
            }

            /* GitHub Diff Colors - Dark Mode */
            [data-color-mode="dark"] {
                --diffBlob-additionLine-bgColor: #2ea04326;
                --diffBlob-additionNum-bgColor: #3fb9504d;
                --diffBlob-additionWord-bgColor: #2ea04366;
                --diffBlob-deletionLine-bgColor: #f851491a;
                --diffBlob-deletionNum-bgColor: #f851494d;
                --diffBlob-deletionWord-bgColor: #f8514966;
                --diffBlob-addition-fgColor: #3fb950;
                --diffBlob-deletion-fgColor: #f85149;
            }

            body {
                min-height: 100vh;
            }

            /* Hide/show highlight.js themes based on color mode */
            /* Default to light theme, hide dark */
            #hljs-dark {
                display: none;
            }

            /* When in dark mode, show dark and hide light */
            [data-color-mode="dark"] #hljs-light {
                display: none;
            }

            [data-color-mode="dark"] #hljs-dark {
                display: block;
            }

            .file-diff-content {
                font-family:
                    ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas,
                    "Liberation Mono", monospace;
                font-size: 12px;
                line-height: 20px;
                overflow-x: auto;
            }

            .diff-line {
                display: flex;
                min-width: max-content;
            }

            .diff-line-number {
                width: 50px;
                min-width: 50px;
                padding: 0 10px;
                text-align: right;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                color: var(--fgColor-muted);
                flex-shrink: 0;
                border-right: 1px solid var(--borderColor-default);
            }

            .diff-line-content {
                flex: 1;
                padding: 0 10px;
                white-space: pre;
            }

            /* Addition (green) lines */
            .diff-line.addition {
                background-color: var(--diffBlob-additionLine-bgColor);
            }

            .diff-line.addition .diff-line-number {
                background-color: var(--diffBlob-additionNum-bgColor);
                color: var(--diffBlob-addition-fgColor);
            }

            .diff-line.addition .diff-line-content {
                color: var(--diffBlob-addition-fgColor);
            }

            /* Deletion (red) lines */
            .diff-line.deletion {
                background-color: var(--diffBlob-deletionLine-bgColor);
            }

            .diff-line.deletion .diff-line-number {
                background-color: var(--diffBlob-deletionNum-bgColor);
                color: var(--diffBlob-deletion-fgColor);
            }

            .diff-line.deletion .diff-line-content {
                color: var(--diffBlob-deletion-fgColor);
            }

            /* Context lines */
            .diff-line.context {
                background-color: transparent;
            }

            .diff-line.context .diff-line-number {
                background-color: transparent;
            }

            /* Word-level highlighting */
            .diff-word-add {
                background-color: var(--diffBlob-additionWord-bgColor);
                border-radius: 2px;
            }

            .diff-word-del {
                background-color: var(--diffBlob-deletionWord-bgColor);
                border-radius: 2px;
            }

            .file-header-container {
                cursor: pointer;
                user-select: none;
            }

            .file-header-container:hover {
                background-color: var(--bgColor-muted);
            }

            .counter-label {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .file-header-items {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
            }

            .file-header-items > * {
                padding-left: 8px !important;
            }

            .file-header-items > *:first-child {
                padding-left: 0 !important;
            }

            .diff-line-wrapper {
                position: relative;
                display: flex;
                min-width: max-content;
            }

            .diff-line-wrapper:hover .add-comment-btn {
                opacity: 1;
            }

            .add-comment-btn {
                position: relative;
                opacity: 0;
                transition: opacity 0.1s;
                width: 22px;
                height: 22px;
                border-radius: 50%;
                background-color: #0969da;
                color: white;
                flex-shrink: 0;
                margin-right: 10px;
                border: none;
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
            }

            .add-comment-btn:hover {
                background-color: #0860ca;
            }

            .comment-form {
                background-color: var(--bgColor-muted);
                border: 1px solid var(--borderColor-default);
                border-radius: 6px;
                margin: 8px 40px 8px 40px;
                padding: 16px;
            }

            .comment-display {
                background-color: var(--bgColor-muted);
                border: 1px solid var(--borderColor-default);
                border-radius: 6px;
                margin: 8px 40px 8px 40px;
                padding: 12px 16px;
            }

            .comment-form textarea {
                width: 100% !important;
                box-sizing: border-box;
            }

            /* Note display styling */
            .note-display {
                background: linear-gradient(
                    135deg,
                    #667eea22 0%,
                    #764ba222 100%
                );
                border: 1px solid #667eea;
                border-left: 4px solid #667eea;
                border-radius: 6px;
                margin: 8px 40px 8px 40px;
                padding: 12px 16px;
            }

            [data-color-mode="light"] .note-display {
                background: linear-gradient(
                    135deg,
                    #667eea11 0%,
                    #764ba211 100%
                );
                border-color: #667eea;
            }

            .note-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                gap: 8px;
            }

            .note-badges {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .note-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
            }

            .note-badge.claude {
                background-color: #667eea;
                color: white;
            }

            .note-badge.copilot {
                background-color: #24292f;
                color: white;
            }

            .note-badge.explanation {
                background-color: #0969da;
                color: white;
            }

            .note-badge.rationale {
                background-color: #8250df;
                color: white;
            }

            .note-badge.suggestion {
                background-color: #1a7f37;
                color: white;
            }

            .note-content {
                line-height: 1.5;
            }

            .notes-panel {
                position: fixed;
                right: 0;
                top: 0;
                bottom: 0;
                width: 400px;
                background-color: var(--bgColor-default);
                border-left: 1px solid var(--borderColor-default);
                overflow-y: auto;
                padding: 16px;
                z-index: 100;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }

            .notes-panel.open {
                transform: translateX(0);
            }

            .notes-panel-toggle {
                position: fixed;
                right: 16px;
                bottom: 16px;
                z-index: 99;
            }

            .note-item {
                background: var(--bgColor-muted);
                border: 1px solid var(--borderColor-default);
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 12px;
                cursor: pointer;
                transition: border-color 0.2s;
            }

            .note-item:hover {
                border-color: #667eea;
            }

            .note-item.dismissed {
                opacity: 0.5;
            }

            /* Staging status badges */
            .staging-badge {
                display: inline-flex;
                align-items: center;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
            }

            .staging-badge.staged {
                background-color: #1a7f37;
                color: white;
            }

            .staging-badge.unstaged {
                background-color: #9a6700;
                color: white;
            }

            /* Uncommitted section styling */
            .uncommitted-section {
                border: 2px dashed var(--borderColor-default);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 24px;
                background-color: var(--bgColor-muted);
            }

            .uncommitted-section-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
            }

            .uncommitted-icon {
                width: 24px;
                height: 24px;
                color: #9a6700;
            }

            .filter-section {
                margin-bottom: 16px;
                padding-bottom: 16px;
                border-bottom: 1px solid var(--borderColor-default);
            }

            .filter-row {
                display: flex;
                gap: 12px;
                align-items: flex-end;
            }

            .filter-row > div {
                flex: 1;
            }

            /* File box styling improvements */
            .Box {
                border-radius: 12px !important;
                overflow: hidden;
                margin-bottom: 16px !important;
            }

            .Box-header {
                border-radius: 0 !important;
            }

            .Box-row:first-child {
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
            }

            .Box-row:last-child {
                border-bottom-left-radius: 12px;
                border-bottom-right-radius: 12px;
            }

            /* Image Diff Styles */
            .image-diff-container {
                padding: 24px;
                background-color: var(--bgColor-muted);
            }

            .image-diff-mode-toggle {
                display: flex;
                gap: 8px;
                margin-bottom: 16px;
            }

            .image-diff-mode-toggle button {
                padding: 4px 12px;
                border: 1px solid var(--borderColor-default);
                border-radius: 6px;
                background-color: var(--bgColor-default);
                cursor: pointer;
                font-size: 12px;
            }

            .image-diff-mode-toggle button.active {
                background-color: var(--bgColor-accent-emphasis, #0969da);
                color: var(--fgColor-onEmphasis, white);
                border-color: var(--bgColor-accent-emphasis, #0969da);
            }

            .image-diff-2up {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 24px;
            }

            .image-diff-single {
                display: flex;
                justify-content: center;
            }

            .image-frame {
                text-align: center;
            }

            .image-frame-inner {
                display: inline-block;
                background-color: var(--bgColor-default);
                border: 2px solid var(--borderColor-default);
                border-radius: 6px;
                padding: 16px;
                /* Checkerboard pattern for transparency */
                background-image:
                    linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                    linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                    linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
                background-size: 16px 16px;
                background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
                background-color: #fff;
            }

            [data-color-mode="dark"] .image-frame-inner {
                background-image:
                    linear-gradient(45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(-45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #2d2d2d 75%),
                    linear-gradient(-45deg, transparent 75%, #2d2d2d 75%);
                background-color: #1c1c1c;
            }

            .image-frame.deletion .image-frame-inner {
                border-color: var(--borderColor-danger-emphasis, #cf222e);
            }

            .image-frame.addition .image-frame-inner {
                border-color: var(--borderColor-success-emphasis, #1a7f37);
            }

            .image-frame img {
                max-width: 100%;
                max-height: 500px;
                object-fit: contain;
                display: block;
            }

            .image-label {
                font-size: 12px;
                font-weight: 600;
                color: var(--fgColor-muted);
                margin-bottom: 8px;
                text-transform: uppercase;
            }

            .image-meta {
                font-size: 13px;
                color: var(--fgColor-muted);
                margin-top: 12px;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            }

            .image-meta-deletion {
                color: var(--fgColor-danger, #cf222e);
            }

            .image-meta-addition {
                color: var(--fgColor-success, #1a7f37);
            }

            .image-error {
                padding: 24px;
                text-align: center;
                color: var(--fgColor-danger);
                background-color: var(--bgColor-danger-muted);
                border-radius: 6px;
            }

            .image-open-link {
                font-size: 11px;
                margin-top: 8px;
            }

            .dimension-change {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 8px 12px;
                margin-bottom: 16px;
                background-color: var(--bgColor-attention-muted);
                border: 1px solid var(--borderColor-attention-muted);
                border-radius: 6px;
                font-size: 12px;
            }

            /* Swipe Mode Styles - custom implementation */
            .swipe-container {
                border: 1px solid var(--borderColor-default);
                border-radius: 8px;
                overflow: hidden;
                background-color: var(--bgColor-default);
            }

            .swipe-images {
                position: relative;
                width: 100%;
                min-height: 200px;
                /* Checkerboard background for transparency */
                background-image:
                    linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
                    linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
                    linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
                background-size: 16px 16px;
                background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
                background-color: #f5f5f5;
                user-select: none;
            }

            [data-color-mode="dark"] .swipe-images {
                background-image:
                    linear-gradient(45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(-45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #2d2d2d 75%),
                    linear-gradient(-45deg, transparent 75%, #2d2d2d 75%);
                background-color: #1c1c1c;
            }

            .swipe-img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: contain;
                object-position: center;
            }

            /* Make the first image (before) set the container height */
            .swipe-before {
                position: relative;
                max-height: 500px;
            }

            .swipe-after {
                max-height: 500px;
            }

            .swipe-divider {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 3px;
                background-color: var(--bgColor-default, #fff);
                box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
                transform: translateX(-50%);
                z-index: 10;
                cursor: ew-resize;
            }

            .swipe-divider::before {
                content: '◀ ▶';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: var(--bgColor-default, #fff);
                color: var(--fgColor-muted, #666);
                font-size: 10px;
                padding: 8px 6px;
                border-radius: 4px;
                box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
                white-space: nowrap;
                letter-spacing: 2px;
                cursor: ew-resize;
                user-select: none;
            }

            .swipe-divider:hover::before,
            .swipe-divider.dragging::before,
            .swipe-divider:focus::before {
                background-color: var(--bgColor-accent-emphasis, #0969da);
                color: var(--fgColor-onEmphasis, #fff);
            }

            .swipe-divider:focus {
                outline: none;
            }

            .swipe-divider:focus::after {
                content: '';
                position: absolute;
                top: -2px;
                bottom: -2px;
                left: -4px;
                right: -4px;
                border: 2px solid var(--bgColor-accent-emphasis, #0969da);
                border-radius: 4px;
                pointer-events: none;
            }

            .swipe-dimensions {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 12px 16px;
                font-size: 13px;
                background-color: var(--bgColor-muted);
                border-top: 1px solid var(--borderColor-default);
            }

            /* Pointer diff toggle for LFS images */
            .pointer-diff-toggle {
                margin-top: 16px;
                font-size: 12px;
            }

            .pointer-diff-toggle summary {
                cursor: pointer;
                color: var(--fgColor-muted);
            }

            .pointer-diff-toggle summary:hover {
                color: var(--fgColor-default);
            }

            /* Onion Skin Mode Styles */
            .onion-container {
                border: 1px solid var(--borderColor-default);
                border-radius: 8px;
                overflow: hidden;
                background-color: var(--bgColor-default);
            }

            .onion-images {
                position: relative;
                width: 100%;
                min-height: 200px;
                /* Checkerboard background for transparency */
                background-image:
                    linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
                    linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
                    linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
                background-size: 16px 16px;
                background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
                background-color: #f5f5f5;
            }

            [data-color-mode="dark"] .onion-images {
                background-image:
                    linear-gradient(45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(-45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #2d2d2d 75%),
                    linear-gradient(-45deg, transparent 75%, #2d2d2d 75%);
                background-color: #1c1c1c;
            }

            .onion-img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: contain;
                object-position: center;
            }

            .onion-bottom {
                position: relative;
                max-height: 500px;
            }

            .onion-top {
                max-height: 500px;
                pointer-events: none;
            }

            .onion-controls {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 16px;
                padding: 12px 16px;
                background-color: var(--bgColor-muted);
                border-top: 1px solid var(--borderColor-default);
            }

            .onion-slider-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .onion-slider-group input[type="range"] {
                width: 150px;
                cursor: pointer;
            }

            .onion-slider-label {
                font-size: 12px;
                color: var(--fgColor-muted);
                min-width: 45px;
            }

            .onion-swap-btn {
                font-size: 12px;
                padding: 4px 12px;
                border-radius: 4px;
                border: 1px solid var(--borderColor-default);
                background-color: var(--bgColor-default);
                color: var(--fgColor-default);
                cursor: pointer;
            }

            .onion-swap-btn:hover {
                background-color: var(--bgColor-muted);
            }

            /* Blink/Flicker Mode Styles */
            .blink-container {
                border: 1px solid var(--borderColor-default);
                border-radius: 8px;
                overflow: hidden;
                background-color: var(--bgColor-default);
            }

            .blink-images {
                position: relative;
                width: 100%;
                min-height: 200px;
                /* Checkerboard background for transparency */
                background-image:
                    linear-gradient(45deg, #e0e0e0 25%, transparent 25%),
                    linear-gradient(-45deg, #e0e0e0 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #e0e0e0 75%),
                    linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
                background-size: 16px 16px;
                background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
                background-color: #f5f5f5;
            }

            [data-color-mode="dark"] .blink-images {
                background-image:
                    linear-gradient(45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(-45deg, #2d2d2d 25%, transparent 25%),
                    linear-gradient(45deg, transparent 75%, #2d2d2d 75%),
                    linear-gradient(-45deg, transparent 75%, #2d2d2d 75%);
                background-color: #1c1c1c;
            }

            .blink-img {
                max-width: 100%;
                max-height: 500px;
                object-fit: contain;
                display: block;
                margin: 0 auto;
            }

            .blink-controls {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 16px;
                padding: 12px 16px;
                background-color: var(--bgColor-muted);
                border-top: 1px solid var(--borderColor-default);
            }

            .blink-play-btn {
                font-size: 14px;
                padding: 4px 16px;
                border-radius: 4px;
                border: 1px solid var(--borderColor-default);
                background-color: var(--bgColor-default);
                color: var(--fgColor-default);
                cursor: pointer;
                min-width: 70px;
            }

            .blink-play-btn:hover {
                background-color: var(--bgColor-muted);
            }

            .blink-play-btn.playing {
                background-color: var(--bgColor-attention-muted);
                border-color: var(--borderColor-attention-muted);
            }

            .blink-speed-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .blink-speed-group select {
                font-size: 12px;
                padding: 4px 8px;
                border-radius: 4px;
                border: 1px solid var(--borderColor-default);
                background-color: var(--bgColor-default);
                color: var(--fgColor-default);
                cursor: pointer;
            }

            .blink-indicator {
                font-size: 12px;
                color: var(--fgColor-muted);
                min-width: 50px;
                text-align: center;
            }

            .blink-indicator.before {
                color: var(--fgColor-danger, #cf222e);
            }

            .blink-indicator.after {
                color: var(--fgColor-success, #1a7f37);
            }

            /* Mode-specific controls row */
            .image-diff-controls {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 16px;
                padding: 8px 12px;
                margin-bottom: 12px;
                background-color: var(--bgColor-muted);
                border: 1px solid var(--borderColor-default);
                border-radius: 6px;
                font-size: 12px;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            function App() {
                const [status, setStatus] = useState(null);
                const [diff, setDiff] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [expandedFiles, setExpandedFiles] = useState(new Set());
                const [comments, setComments] = useState({});
                const [commentText, setCommentText] = useState({});
                const [activeCommentLine, setActiveCommentLine] =
                    useState(null);
                const [notes, setNotes] = useState([]);
                const [notesPanelOpen, setNotesPanelOpen] = useState(false);
                const [noteFilters, setNoteFilters] = useState({
                    showDismissed: false,
                    author: "all",
                    type: "all",
                });

                // Theme management
                const getInitialTheme = () => {
                    const stored = localStorage.getItem("guck-theme");
                    if (stored) return stored;
                    return window.matchMedia("(prefers-color-scheme: dark)")
                        .matches
                        ? "dark"
                        : "light";
                };

                const [theme, setTheme] = useState(getInitialTheme);

                useEffect(() => {
                    const html = document.documentElement;
                    html.setAttribute("data-color-mode", theme);
                    localStorage.setItem("guck-theme", theme);
                }, [theme]);

                const toggleTheme = () => {
                    setTheme((prev) => (prev === "dark" ? "light" : "dark"));
                };

                useEffect(() => {
                    loadData();
                }, []);

                function updateDocumentTitle(repoPath, remoteURL) {
                    let title = "Guck";

                    if (remoteURL) {
                        // Try to extract account/repo from remote URL
                        // Supports formats like:
                        // - https://github.com/account/repo.git
                        // - git@github.com:account/repo.git
                        // - https://github.com/account/repo
                        const match = remoteURL.match(
                            /[:/]([^/]+\/[^/]+?)(\.git)?$/,
                        );
                        if (match) {
                            title = match[1];
                        } else {
                            // Fallback to local repo name
                            title = repoPath.split("/").pop();
                        }
                    } else {
                        // No remote URL, use local repository name
                        title = repoPath.split("/").pop();
                    }

                    document.title = title;
                }

                async function loadData() {
                    try {
                        setLoading(true);
                        const [statusRes, diffRes, commentsRes, notesRes] =
                            await Promise.all([
                                fetch("/api/status"),
                                fetch("/api/diff"),
                                fetch("/api/comments"),
                                fetch("/api/notes"),
                            ]);

                        if (
                            !statusRes.ok ||
                            !diffRes.ok ||
                            !commentsRes.ok ||
                            !notesRes.ok
                        ) {
                            throw new Error("Failed to load data");
                        }

                        const statusData = await statusRes.json();
                        const diffData = await diffRes.json();
                        const commentsData = await commentsRes.json();
                        const notesData = await notesRes.json();

                        setStatus(statusData);
                        setDiff(diffData);
                        setNotes(notesData || []);

                        // Update document title with repository name
                        updateDocumentTitle(
                            diffData.repo_path,
                            diffData.remote_url,
                        );

                        // Group comments by file_path
                        const commentsByFile = {};
                        commentsData.forEach((comment) => {
                            if (!commentsByFile[comment.file_path]) {
                                commentsByFile[comment.file_path] = [];
                            }
                            commentsByFile[comment.file_path].push(comment);
                        });
                        setComments(commentsByFile);

                        setError(null);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                }

                async function toggleViewed(filePath, currentlyViewed) {
                    try {
                        const endpoint = currentlyViewed
                            ? "/api/unmark-viewed"
                            : "/api/mark-viewed";
                        const res = await fetch(endpoint, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ file_path: filePath }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to update viewed status");
                        }

                        setDiff((prev) => ({
                            ...prev,
                            files: prev.files.map((f) =>
                                f.path === filePath
                                    ? { ...f, viewed: !currentlyViewed }
                                    : f,
                            ),
                        }));

                        // Collapse the file when marking as viewed
                        if (!currentlyViewed) {
                            setExpandedFiles((prev) => {
                                const next = new Set(prev);
                                next.delete(filePath);
                                return next;
                            });
                        }
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function addComment(filePath, lineNumber = null) {
                    const key =
                        lineNumber !== null
                            ? `${filePath}:${lineNumber}`
                            : filePath;
                    const text = commentText[key];
                    if (!text || !text.trim()) return;

                    try {
                        const res = await fetch("/api/comments", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                file_path: filePath,
                                line_number: lineNumber,
                                text: text.trim(),
                            }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to add comment");
                        }

                        const newComment = await res.json();

                        setComments((prev) => ({
                            ...prev,
                            [filePath]: [...(prev[filePath] || []), newComment],
                        }));

                        setCommentText((prev) => ({
                            ...prev,
                            [key]: "",
                        }));

                        setActiveCommentLine(null);
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function resolveComment(commentId) {
                    try {
                        const res = await fetch("/api/comments/resolve", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                comment_id: commentId,
                            }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to resolve comment");
                        }

                        // Update local state to mark comment as resolved
                        setComments((prev) => {
                            const updated = {};
                            for (const [
                                filePath,
                                fileComments,
                            ] of Object.entries(prev)) {
                                updated[filePath] = fileComments.map((c) =>
                                    c.id === commentId
                                        ? { ...c, resolved: true }
                                        : c,
                                );
                            }
                            return updated;
                        });
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function dismissNote(noteId) {
                    try {
                        const res = await fetch("/api/notes/dismiss", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                note_id: noteId,
                            }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to dismiss note");
                        }

                        // Update local state to mark note as dismissed
                        setNotes((prev) =>
                            prev.map((n) =>
                                n.id === noteId ? { ...n, dismissed: true } : n,
                            ),
                        );
                    } catch (err) {
                        setError(err.message);
                    }
                }

                function toggleFile(filePath) {
                    setExpandedFiles((prev) => {
                        const next = new Set(prev);
                        if (next.has(filePath)) {
                            next.delete(filePath);
                        } else {
                            next.add(filePath);
                        }
                        return next;
                    });
                }

                function getLanguageFromPath(filePath) {
                    const ext = filePath.split(".").pop().toLowerCase();
                    const langMap = {
                        js: "javascript",
                        jsx: "javascript",
                        ts: "typescript",
                        tsx: "typescript",
                        rs: "rust",
                        py: "python",
                        go: "go",
                        json: "json",
                        yaml: "yaml",
                        yml: "yaml",
                        md: "markdown",
                        html: "xml",
                        css: "css",
                        sh: "bash",
                        bash: "bash",
                        rb: "ruby",
                        java: "java",
                        c: "c",
                        cpp: "cpp",
                        h: "c",
                        hpp: "cpp",
                    };
                    return langMap[ext] || "plaintext";
                }

                function getFileNotes(filePath, lineNumber = null) {
                    return notes.filter((note) => {
                        if (note.file_path !== filePath) return false;
                        if (
                            lineNumber !== null &&
                            note.line_number !== lineNumber
                        )
                            return false;
                        if (
                            lineNumber === null &&
                            note.line_number !== null &&
                            note.line_number !== undefined
                        )
                            return false;
                        return true;
                    });
                }

                function renderDiffLine(line, index, filePath, fileComments) {
                    const prefix = line[0];
                    const content = line.slice(1);

                    let lineClass = "context";

                    if (prefix === "+") {
                        lineClass = "addition";
                    } else if (prefix === "-") {
                        lineClass = "deletion";
                    }

                    const lineNumber = index + 1;
                    const lineComments = (fileComments || []).filter(
                        (c) => c.line_number === lineNumber,
                    );
                    const lineNotes = getFileNotes(filePath, lineNumber).filter(
                        (n) => !n.dismissed,
                    );
                    const commentKey = `${filePath}:${lineNumber}`;
                    const isCommentActive = activeCommentLine === commentKey;

                    // Apply syntax highlighting to all lines (context, additions, and deletions)
                    let displayContent = content;
                    if (window.hljs) {
                        const language = getLanguageFromPath(filePath);
                        try {
                            const result = hljs.highlight(content, {
                                language,
                                ignoreIllegals: true,
                            });
                            displayContent = result.value;
                        } catch (e) {
                            // Fallback to plain text
                            displayContent = content;
                        }
                    }

                    return (
                        <React.Fragment key={index}>
                            <div className="diff-line-wrapper">
                                <button
                                    className="add-comment-btn"
                                    onClick={() =>
                                        setActiveCommentLine(
                                            isCommentActive ? null : commentKey,
                                        )
                                    }
                                    title="Add a comment to this line"
                                >
                                    +
                                </button>
                                <div className={`diff-line ${lineClass}`}>
                                    <span className="diff-line-number">
                                        {lineNumber}
                                    </span>
                                    <span
                                        className="diff-line-content"
                                        dangerouslySetInnerHTML={{
                                            __html: displayContent,
                                        }}
                                    />
                                </div>
                            </div>
                            {lineNotes.map((note) => (
                                <div key={note.id} className="note-display">
                                    <div className="note-header">
                                        <div className="note-badges">
                                            <span
                                                className={`note-badge ${note.author}`}
                                            >
                                                {note.author}
                                            </span>
                                            {note.type && (
                                                <span
                                                    className={`note-badge ${note.type}`}
                                                >
                                                    {note.type}
                                                </span>
                                            )}
                                        </div>
                                        <div className="d-flex gap-2">
                                            <span className="text-small color-fg-muted">
                                                {new Date(
                                                    note.timestamp * 1000,
                                                ).toLocaleString()}
                                            </span>
                                            <button
                                                className="btn btn-sm"
                                                onClick={() =>
                                                    dismissNote(note.id)
                                                }
                                            >
                                                Dismiss
                                            </button>
                                        </div>
                                    </div>
                                    <div className="note-content">
                                        {note.text}
                                    </div>
                                    {note.metadata &&
                                        Object.keys(note.metadata).length >
                                            0 && (
                                            <div className="text-small color-fg-muted mt-2">
                                                {Object.entries(
                                                    note.metadata,
                                                ).map(([key, value]) => (
                                                    <span
                                                        key={key}
                                                        className="mr-2"
                                                    >
                                                        {key}: {value}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                </div>
                            ))}
                            {lineComments
                                .filter((c) => !c.resolved)
                                .map((comment) => (
                                    <div
                                        key={comment.id}
                                        className="comment-display"
                                    >
                                        <div className="d-flex flex-justify-between flex-items-center mb-1">
                                            <div className="text-small color-fg-muted">
                                                {new Date(
                                                    comment.timestamp * 1000,
                                                ).toLocaleString()}
                                            </div>
                                            <button
                                                className="btn btn-sm"
                                                onClick={() =>
                                                    resolveComment(comment.id)
                                                }
                                            >
                                                Resolve
                                            </button>
                                        </div>
                                        <div>{comment.text}</div>
                                    </div>
                                ))}
                            {isCommentActive && (
                                <div className="comment-form">
                                    <div className="text-bold mb-2">
                                        Add a comment on line {lineNumber}
                                    </div>
                                    <textarea
                                        className="form-control mb-2"
                                        style={{ width: "100%" }}
                                        placeholder="Leave a comment"
                                        rows="3"
                                        value={commentText[commentKey] || ""}
                                        onChange={(e) =>
                                            setCommentText((prev) => ({
                                                ...prev,
                                                [commentKey]: e.target.value,
                                            }))
                                        }
                                        autoFocus
                                    />
                                    <div
                                        className="d-flex"
                                        style={{ gap: "8px" }}
                                    >
                                        <button
                                            className="btn btn-sm"
                                            onClick={() =>
                                                setActiveCommentLine(null)
                                            }
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            className="btn btn-primary btn-sm"
                                            onClick={() =>
                                                addComment(filePath, lineNumber)
                                            }
                                            disabled={
                                                !commentText[commentKey]?.trim()
                                            }
                                        >
                                            Comment
                                        </button>
                                    </div>
                                </div>
                            )}
                        </React.Fragment>
                    );
                }

                function getStatusLabel(status) {
                    const statusMap = {
                        added: { label: "Added", color: "success" },
                        modified: { label: "Modified", color: "attention" },
                        deleted: { label: "Deleted", color: "danger" },
                        renamed: { label: "Renamed", color: "accent" },
                    };
                    return (
                        statusMap[status] || { label: status, color: "default" }
                    );
                }

                // ImageDiff component for 2-Up, Swipe, Onion, and Blink modes
                function ImageDiff({ baseUrl, headUrl, status, patch }) {
                    const [mode, setMode] = useState(() => {
                        const stored = localStorage.getItem("guck-image-diff-mode");
                        return stored || "2up";
                    });
                    const [baseDims, setBaseDims] = useState(null);
                    const [headDims, setHeadDims] = useState(null);
                    const [baseError, setBaseError] = useState(false);
                    const [headError, setHeadError] = useState(false);
                    const [sliderValue, setSliderValue] = useState(50);

                    // Onion skin state
                    const [onionOpacity, setOnionOpacity] = useState(() => {
                        const stored = localStorage.getItem("guck-image-onion-opacity");
                        return stored ? parseInt(stored, 10) : 50;
                    });
                    const [onionSwapped, setOnionSwapped] = useState(() => {
                        const stored = localStorage.getItem("guck-image-onion-swapped");
                        return stored === "true";
                    });

                    // Blink mode state
                    const [blinkHz, setBlinkHz] = useState(() => {
                        const stored = localStorage.getItem("guck-image-blink-hz");
                        return stored ? parseInt(stored, 10) : 4;
                    });
                    const [blinkPlaying, setBlinkPlaying] = useState(true);
                    const [showBefore, setShowBefore] = useState(true);

                    const handleModeChange = (newMode) => {
                        setMode(newMode);
                        localStorage.setItem("guck-image-diff-mode", newMode);
                    };

                    const handleOnionOpacityChange = (value) => {
                        setOnionOpacity(value);
                        localStorage.setItem("guck-image-onion-opacity", value.toString());
                    };

                    const handleOnionSwap = () => {
                        const newValue = !onionSwapped;
                        setOnionSwapped(newValue);
                        localStorage.setItem("guck-image-onion-swapped", newValue.toString());
                    };

                    const handleBlinkHzChange = (value) => {
                        setBlinkHz(value);
                        localStorage.setItem("guck-image-blink-hz", value.toString());
                    };

                    // Blink effect
                    React.useEffect(() => {
                        if (mode !== "blink" || !blinkPlaying) return;
                        const interval = setInterval(() => {
                            setShowBefore(v => !v);
                        }, 1000 / blinkHz);
                        return () => clearInterval(interval);
                    }, [mode, blinkHz, blinkPlaying]);

                    const handleBaseLoad = (e) => {
                        setBaseDims({
                            width: e.target.naturalWidth,
                            height: e.target.naturalHeight,
                        });
                    };

                    const handleHeadLoad = (e) => {
                        setHeadDims({
                            width: e.target.naturalWidth,
                            height: e.target.naturalHeight,
                        });
                    };

                    const hasBothImages = baseUrl && headUrl;
                    const showDimensionChange = baseDims && headDims &&
                        (baseDims.width !== headDims.width || baseDims.height !== headDims.height);

                    // Format dimensions like GitHub: "W: 533px | H: 533px"
                    const formatDims = (dims, colorClass) => {
                        if (!dims) return null;
                        return (
                            <div className={`image-meta ${colorClass || ''}`}>
                                W: <span style={{ fontWeight: 500 }}>{dims.width}px</span> | H: <span style={{ fontWeight: 500 }}>{dims.height}px</span>
                            </div>
                        );
                    };

                    // Render 2-Up mode
                    const render2Up = () => {
                        if (!hasBothImages) {
                            // Single image (added or deleted)
                            const isAdded = status === "added";
                            const dims = isAdded ? headDims : baseDims;
                            const error = isAdded ? headError : baseError;
                            const url = isAdded ? headUrl : baseUrl;
                            const colorClass = isAdded ? "image-meta-addition" : "image-meta-deletion";
                            const frameClass = isAdded ? "addition" : "deletion";

                            return (
                                <div className="image-diff-single">
                                    <div className={`image-frame ${frameClass}`} style={{ maxWidth: "600px" }}>
                                        {error ? (
                                            <div className="image-error">Failed to load image</div>
                                        ) : (
                                            <>
                                                <div className="image-frame-inner">
                                                    <img
                                                        src={url}
                                                        alt={isAdded ? "Added" : "Deleted"}
                                                        onLoad={isAdded ? handleHeadLoad : handleBaseLoad}
                                                        onError={() => isAdded ? setHeadError(true) : setBaseError(true)}
                                                    />
                                                </div>
                                                {formatDims(dims, colorClass)}
                                            </>
                                        )}
                                    </div>
                                </div>
                            );
                        }

                        return (
                            <div className="image-diff-2up">
                                <div className="image-frame deletion">
                                    {baseError ? (
                                        <div className="image-error">Failed to load image</div>
                                    ) : (
                                        <>
                                            <div className="image-frame-inner">
                                                <img
                                                    src={baseUrl}
                                                    alt="Before"
                                                    onLoad={handleBaseLoad}
                                                    onError={() => setBaseError(true)}
                                                />
                                            </div>
                                            {formatDims(baseDims, "image-meta-deletion")}
                                        </>
                                    )}
                                </div>
                                <div className="image-frame addition">
                                    {headError ? (
                                        <div className="image-error">Failed to load image</div>
                                    ) : (
                                        <>
                                            <div className="image-frame-inner">
                                                <img
                                                    src={headUrl}
                                                    alt="After"
                                                    onLoad={handleHeadLoad}
                                                    onError={() => setHeadError(true)}
                                                />
                                            </div>
                                            {formatDims(headDims, "image-meta-addition")}
                                        </>
                                    )}
                                </div>
                            </div>
                        );
                    };

                    // Render Swipe mode - custom implementation with both images clipped
                    const swipeContainerRef = React.useRef(null);
                    const cachedRectRef = React.useRef(null);
                    const [isDragging, setIsDragging] = React.useState(false);

                    const handleDragStart = (e) => {
                        e.preventDefault();
                        // Cache bounding rect on drag start for performance
                        if (swipeContainerRef.current) {
                            cachedRectRef.current = swipeContainerRef.current.getBoundingClientRect();
                        }
                        setIsDragging(true);
                    };

                    const handleDragMove = React.useCallback((e) => {
                        if (!isDragging || !cachedRectRef.current) return;

                        const rect = cachedRectRef.current;
                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const x = clientX - rect.left;
                        const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                        setSliderValue(percentage);
                    }, [isDragging]);

                    const handleDragEnd = React.useCallback(() => {
                        setIsDragging(false);
                        cachedRectRef.current = null;
                    }, []);

                    // Keyboard handler for accessibility
                    const handleKeyDown = React.useCallback((e) => {
                        const step = e.shiftKey ? 10 : 1; // Larger steps with shift
                        if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            setSliderValue(v => Math.max(0, v - step));
                        } else if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            setSliderValue(v => Math.min(100, v + step));
                        } else if (e.key === 'Home') {
                            e.preventDefault();
                            setSliderValue(0);
                        } else if (e.key === 'End') {
                            e.preventDefault();
                            setSliderValue(100);
                        }
                    }, []);

                    // Add/remove global event listeners for drag
                    React.useEffect(() => {
                        if (isDragging) {
                            document.addEventListener('mousemove', handleDragMove);
                            document.addEventListener('mouseup', handleDragEnd);
                            document.addEventListener('touchmove', handleDragMove);
                            document.addEventListener('touchend', handleDragEnd);
                        }
                        return () => {
                            document.removeEventListener('mousemove', handleDragMove);
                            document.removeEventListener('mouseup', handleDragEnd);
                            document.removeEventListener('touchmove', handleDragMove);
                            document.removeEventListener('touchend', handleDragEnd);
                        };
                    }, [isDragging, handleDragMove, handleDragEnd]);

                    const renderSwipe = () => {
                        if (!hasBothImages) {
                            return render2Up(); // Fallback to 2-up for single images
                        }

                        return (
                            <div className="swipe-container">
                                <div
                                    className="swipe-images"
                                    ref={swipeContainerRef}
                                    onMouseDown={handleDragStart}
                                    onTouchStart={handleDragStart}
                                    style={{ cursor: isDragging ? 'ew-resize' : 'default' }}
                                >
                                    {/* Before image: show from left edge to slider */}
                                    <img
                                        src={baseUrl}
                                        alt="Before"
                                        className="swipe-img swipe-before"
                                        style={{ clipPath: `inset(0 ${100 - sliderValue}% 0 0)` }}
                                        onLoad={handleBaseLoad}
                                        onError={() => setBaseError(true)}
                                        draggable={false}
                                    />
                                    {/* After image: show from slider to right edge */}
                                    <img
                                        src={headUrl}
                                        alt="After"
                                        className="swipe-img swipe-after"
                                        style={{ clipPath: `inset(0 0 0 ${sliderValue}%)` }}
                                        onLoad={handleHeadLoad}
                                        onError={() => setHeadError(true)}
                                        draggable={false}
                                    />
                                    {/* Divider line with draggable handle */}
                                    <div
                                        className={`swipe-divider ${isDragging ? 'dragging' : ''}`}
                                        style={{ left: `${sliderValue}%` }}
                                        tabIndex={0}
                                        role="slider"
                                        aria-label="Image comparison slider"
                                        aria-valuemin={0}
                                        aria-valuemax={100}
                                        aria-valuenow={Math.round(sliderValue)}
                                        onKeyDown={handleKeyDown}
                                    />
                                </div>
                                {(baseDims || headDims) && (
                                    <div className="swipe-dimensions">
                                        {baseDims && (
                                            <span className="image-meta-deletion">
                                                W: {baseDims.width}px | H: {baseDims.height}px
                                            </span>
                                        )}
                                        <span style={{ margin: "0 16px" }}>→</span>
                                        {headDims && (
                                            <span className="image-meta-addition">
                                                W: {headDims.width}px | H: {headDims.height}px
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    };

                    // Render Onion Skin mode
                    const renderOnion = () => {
                        if (!hasBothImages) {
                            return render2Up(); // Fallback to 2-up for single images
                        }

                        // Determine which image is on top based on swap state
                        const bottomUrl = onionSwapped ? headUrl : baseUrl;
                        const topUrl = onionSwapped ? baseUrl : headUrl;
                        const bottomAlt = onionSwapped ? "After" : "Before";
                        const topAlt = onionSwapped ? "Before" : "After";

                        return (
                            <div className="onion-container">
                                <div className="onion-images">
                                    {/* Bottom image (fully visible) */}
                                    <img
                                        src={bottomUrl}
                                        alt={bottomAlt}
                                        className="onion-img onion-bottom"
                                        onLoad={onionSwapped ? handleHeadLoad : handleBaseLoad}
                                        onError={() => onionSwapped ? setHeadError(true) : setBaseError(true)}
                                    />
                                    {/* Top image (with opacity) */}
                                    <img
                                        src={topUrl}
                                        alt={topAlt}
                                        className="onion-img onion-top"
                                        style={{ opacity: onionOpacity / 100 }}
                                        onLoad={onionSwapped ? handleBaseLoad : handleHeadLoad}
                                        onError={() => onionSwapped ? setBaseError(true) : setHeadError(true)}
                                    />
                                </div>
                                <div className="onion-controls">
                                    <div className="onion-slider-group">
                                        <span className="onion-slider-label">Opacity:</span>
                                        <input
                                            type="range"
                                            min="0"
                                            max="100"
                                            value={onionOpacity}
                                            onChange={(e) => handleOnionOpacityChange(parseInt(e.target.value, 10))}
                                        />
                                        <span className="onion-slider-label">{onionOpacity}%</span>
                                    </div>
                                    <button className="onion-swap-btn" onClick={handleOnionSwap}>
                                        {onionSwapped ? "Before on top" : "After on top"}
                                    </button>
                                    <span style={{ fontSize: "11px", color: "var(--fgColor-muted)" }}>
                                        (Currently: {onionSwapped ? "Before" : "After"} over {onionSwapped ? "After" : "Before"})
                                    </span>
                                </div>
                            </div>
                        );
                    };

                    // Render Blink/Flicker mode
                    const renderBlink = () => {
                        if (!hasBothImages) {
                            return render2Up(); // Fallback to 2-up for single images
                        }

                        const currentUrl = showBefore ? baseUrl : headUrl;
                        const currentAlt = showBefore ? "Before" : "After";

                        return (
                            <div className="blink-container">
                                <div className="blink-images">
                                    <img
                                        src={currentUrl}
                                        alt={currentAlt}
                                        className="blink-img"
                                        onLoad={showBefore ? handleBaseLoad : handleHeadLoad}
                                        onError={() => showBefore ? setBaseError(true) : setHeadError(true)}
                                    />
                                </div>
                                <div className="blink-controls">
                                    <button
                                        className={`blink-play-btn ${blinkPlaying ? "playing" : ""}`}
                                        onClick={() => setBlinkPlaying(!blinkPlaying)}
                                    >
                                        {blinkPlaying ? "Pause" : "Play"}
                                    </button>
                                    <div className="blink-speed-group">
                                        <span style={{ fontSize: "12px", color: "var(--fgColor-muted)" }}>Speed:</span>
                                        <select
                                            value={blinkHz}
                                            onChange={(e) => handleBlinkHzChange(parseInt(e.target.value, 10))}
                                        >
                                            <option value="2">2 Hz</option>
                                            <option value="3">3 Hz</option>
                                            <option value="4">4 Hz</option>
                                            <option value="5">5 Hz</option>
                                            <option value="6">6 Hz</option>
                                        </select>
                                    </div>
                                    <span className={`blink-indicator ${showBefore ? "before" : "after"}`}>
                                        {showBefore ? "Before" : "After"}
                                    </span>
                                </div>
                            </div>
                        );
                    };

                    // Get current render function based on mode
                    const renderContent = () => {
                        switch (mode) {
                            case "swipe":
                                return renderSwipe();
                            case "onion":
                                return renderOnion();
                            case "blink":
                                return renderBlink();
                            case "2up":
                            default:
                                return render2Up();
                        }
                    };

                    return (
                        <div className="image-diff-container">
                            {/* Mode toggle - only show if we have both images */}
                            {hasBothImages && (
                                <div className="image-diff-mode-toggle">
                                    <button
                                        className={mode === "2up" ? "active" : ""}
                                        onClick={() => handleModeChange("2up")}
                                    >
                                        2-Up
                                    </button>
                                    <button
                                        className={mode === "swipe" ? "active" : ""}
                                        onClick={() => handleModeChange("swipe")}
                                    >
                                        Swipe
                                    </button>
                                    <button
                                        className={mode === "onion" ? "active" : ""}
                                        onClick={() => handleModeChange("onion")}
                                    >
                                        Onion
                                    </button>
                                    <button
                                        className={mode === "blink" ? "active" : ""}
                                        onClick={() => handleModeChange("blink")}
                                    >
                                        Blink
                                    </button>
                                </div>
                            )}

                            {/* Dimension change indicator */}
                            {showDimensionChange && (
                                <div className="dimension-change">
                                    <span>Size changed:</span>
                                    <span>{baseDims.width} × {baseDims.height}</span>
                                    <span>→</span>
                                    <span>{headDims.width} × {headDims.height}</span>
                                </div>
                            )}

                            {/* Render based on mode */}
                            {renderContent()}

                            {/* Optional: Show pointer diff for LFS files */}
                            {patch && patch.includes("git-lfs.github.com") && (
                                <details className="pointer-diff-toggle">
                                    <summary>Show LFS pointer diff</summary>
                                    <div className="file-diff-content mt-2">
                                        {patch
                                            .split("\n")
                                            .filter((line) => {
                                                return !(
                                                    line.startsWith("diff --git") ||
                                                    line.startsWith("index ") ||
                                                    line.startsWith("--- ") ||
                                                    line.startsWith("+++ ") ||
                                                    line.startsWith("new file mode") ||
                                                    line.startsWith("old file mode") ||
                                                    line.startsWith("deleted file mode") ||
                                                    line.startsWith("@@")
                                                );
                                            })
                                            .map((line, index) => {
                                                if (line.length === 0) return null;
                                                const prefix = line[0];
                                                let lineClass = "context";
                                                if (prefix === "+") lineClass = "addition";
                                                else if (prefix === "-") lineClass = "deletion";

                                                return (
                                                    <div key={index} className={`diff-line ${lineClass}`}>
                                                        <span className="diff-line-number">{index + 1}</span>
                                                        <span className="diff-line-content">{line.slice(1)}</span>
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </details>
                            )}
                        </div>
                    );
                }

                if (loading) {
                    return (
                        <div className="container-lg p-4">
                            <div className="Subhead">
                                <h1 className="Subhead-heading">
                                    Loading diff...
                                </h1>
                            </div>
                        </div>
                    );
                }

                if (error) {
                    return (
                        <div className="container-lg p-4">
                            <div className="flash flash-error">
                                <strong>Error:</strong> {error}
                            </div>
                        </div>
                    );
                }

                const viewedCount =
                    diff?.files.filter((f) => f.viewed).length || 0;
                const totalCount = diff?.files.length || 0;
                const uncommittedCount = diff?.uncommitted_files?.length || 0;

                // Filter notes based on current filters
                const filteredNotes = notes.filter((note) => {
                    if (!noteFilters.showDismissed && note.dismissed)
                        return false;
                    if (
                        noteFilters.author !== "all" &&
                        note.author !== noteFilters.author
                    )
                        return false;
                    if (
                        noteFilters.type !== "all" &&
                        note.type !== noteFilters.type
                    )
                        return false;
                    return true;
                });

                // Get unique authors and types for filters
                const uniqueAuthors = [...new Set(notes.map((n) => n.author))];
                const uniqueTypes = [
                    ...new Set(notes.map((n) => n.type).filter(Boolean)),
                ];

                // Count total non-dismissed notes
                const activeNotesCount = notes.filter(
                    (n) => !n.dismissed,
                ).length;

                return (
                    <div className="container-lg p-2">
                        <div className="Subhead mb-5 d-flex flex-justify-between flex-items-center">
                            <div>
                                <div
                                    className="Subhead-heading d-flex flex-items-center"
                                    style={{ fontSize: "28px", gap: "12px" }}
                                >
                                    <a
                                        href="https://github.com/tuist/guck"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="Link--primary text-bold"
                                    >
                                        Guck
                                    </a>
                                </div>
                                <div className="Subhead-description mt-1">
                                    <span className="Label Label--secondary mr-2">
                                        Branch: {diff?.branch}
                                    </span>
                                    <span className="Label Label--secondary mr-2">
                                        Commit: {diff?.commit.slice(0, 7)}
                                    </span>
                                    <span className="color-fg-muted text-small">
                                        · A project by{" "}
                                        <a
                                            href="https://tuist.io"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="Link--primary"
                                        >
                                            Tuist
                                        </a>
                                    </span>
                                </div>
                            </div>
                            <button
                                className="btn btn-sm btn-invisible"
                                onClick={toggleTheme}
                                title="Toggle theme"
                                aria-label="Toggle theme"
                            >
                                {theme === "dark" ? (
                                    <svg
                                        className="octicon"
                                        width="16"
                                        height="16"
                                        viewBox="0 0 16 16"
                                        fill="currentColor"
                                    >
                                        <path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8Zm0-1.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Zm5.657-8.157a.75.75 0 0 1 0 1.061l-1.061 1.06a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734l1.06-1.06a.75.75 0 0 1 1.06 0Zm-9.193 9.193a.75.75 0 0 1 0 1.06l-1.06 1.061a.75.75 0 1 1-1.061-1.06l1.06-1.061a.75.75 0 0 1 1.061 0ZM8 0a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0ZM3 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 3 8Zm13 0a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 16 8Zm-8 5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 8 13Zm3.536-1.464a.75.75 0 0 1 1.06 0l1.061 1.06a.75.75 0 0 1-1.06 1.061l-1.061-1.06a.75.75 0 0 1 0-1.061ZM2.343 2.343a.75.75 0 0 1 1.061 0l1.06 1.061a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018l-1.06-1.06a.75.75 0 0 1 0-1.06Z"></path>
                                    </svg>
                                ) : (
                                    <svg
                                        className="octicon"
                                        width="16"
                                        height="16"
                                        viewBox="0 0 16 16"
                                        fill="currentColor"
                                    >
                                        <path d="M9.598 1.591a.749.749 0 0 1 .785-.175 7.001 7.001 0 1 1-8.967 8.967.75.75 0 0 1 .961-.96 5.5 5.5 0 0 0 7.046-7.046.75.75 0 0 1 .175-.786Zm1.616 1.945a7 7 0 0 1-7.678 7.678 5.499 5.499 0 1 0 7.678-7.678Z"></path>
                                    </svg>
                                )}
                            </button>
                        </div>

                        {/* Uncommitted Changes Section */}
                        {uncommittedCount > 0 && (
                            <div className="uncommitted-section">
                                <div className="uncommitted-section-header">
                                    <svg className="uncommitted-icon" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M5.75 1a.75.75 0 0 0-.75.75v3c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-3a.75.75 0 0 0-.75-.75h-4.5zm.75 3V2.5h3V4h-3zm-2.874-.467a.75.75 0 0 0-.752-1.298A7.81 7.81 0 0 0 0 8.25a7.81 7.81 0 0 0 2.874 6.015.75.75 0 1 0 .752-1.298A6.31 6.31 0 0 1 1.5 8.25a6.31 6.31 0 0 1 2.126-4.717zm8.248 0a.75.75 0 0 1 .752-1.298A7.81 7.81 0 0 1 16 8.25a7.81 7.81 0 0 1-2.874 6.015.75.75 0 1 1-.752-1.298A6.31 6.31 0 0 0 14.5 8.25a6.31 6.31 0 0 0-2.126-4.717zM8.75 9.5a.75.75 0 0 0-1.5 0v2.75a.75.75 0 0 0 1.5 0V9.5z"/>
                                    </svg>
                                    <div>
                                        <h3 className="h4 mb-0">Uncommitted Changes</h3>
                                        <span className="color-fg-muted text-small">
                                            {uncommittedCount} file{uncommittedCount !== 1 ? "s" : ""} with uncommitted changes
                                        </span>
                                    </div>
                                </div>
                                <div className="d-flex flex-column gap-3">
                                    {diff.uncommitted_files.map((file) => {
                                        const statusInfo = getStatusLabel(file.status);
                                        const fileKey = `uncommitted:${file.path}:${file.staging_status}`;
                                        const isExpanded = expandedFiles.has(fileKey);

                                        return (
                                            <div key={fileKey} className="Box">
                                                <div
                                                    className="Box-header file-header-container"
                                                    onClick={() => toggleFile(fileKey)}
                                                >
                                                    <div
                                                        className="d-flex flex-justify-between flex-items-center"
                                                        style={{ fontSize: "14px" }}
                                                    >
                                                        <div className="d-flex flex-items-center">
                                                            <span className="text-mono text-bold mr-2">
                                                                {file.path}
                                                            </span>
                                                            <span className={`staging-badge ${file.staging_status} mr-2`}>
                                                                {file.staging_status}
                                                            </span>
                                                            <span className={`Label Label--${statusInfo.color} mr-2`}>
                                                                {statusInfo.label}
                                                            </span>
                                                            <span className="color-fg-success mr-2">
                                                                +{file.additions}
                                                            </span>
                                                            <span className="color-fg-danger">
                                                                -{file.deletions}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {isExpanded && (
                                                    <div className="Box-body p-0">
                                                        {file.is_image ? (
                                                            <ImageDiff
                                                                baseUrl={file.image_base_url}
                                                                headUrl={file.image_head_url}
                                                                status={file.status}
                                                                patch={file.patch}
                                                            />
                                                        ) : (
                                                            <div className="file-diff-content">
                                                                {file.patch
                                                                    .split("\n")
                                                                    .filter((line) => {
                                                                        return !(
                                                                            line.startsWith("diff --git") ||
                                                                            line.startsWith("index ") ||
                                                                            line.startsWith("--- ") ||
                                                                            line.startsWith("+++ ") ||
                                                                            line.startsWith("new file mode") ||
                                                                            line.startsWith("old file mode") ||
                                                                            line.startsWith("deleted file mode") ||
                                                                            line.startsWith("@@")
                                                                        );
                                                                    })
                                                                    .map((line, index) =>
                                                                        renderDiffLine(line, index, file.path, comments[file.path] || [])
                                                                    )}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {diff && diff.files.length > 0 ? (
                            <>
                                <div className="Box mb-3">
                                    <div
                                        className="Box-row d-flex flex-justify-between flex-items-center"
                                        style={{ fontSize: "14px" }}
                                    >
                                        <div
                                            style={{
                                                display: "flex",
                                                alignItems: "center",
                                                gap: "8px",
                                            }}
                                        >
                                            <span>
                                                <strong>{totalCount}</strong>{" "}
                                                committed file
                                                {totalCount !== 1
                                                    ? "s"
                                                    : ""}{" "}
                                                changed
                                            </span>
                                            <span className="counter-label">
                                                <span className="Counter Counter--success">
                                                    {viewedCount}
                                                </span>
                                                <span
                                                    className="color-fg-muted"
                                                    style={{
                                                        marginLeft: "4px",
                                                    }}
                                                >
                                                    reviewed
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="d-flex flex-column gap-4">
                                    {diff.files.map((file) => {
                                        const statusInfo = getStatusLabel(
                                            file.status,
                                        );
                                        const isExpanded = expandedFiles.has(
                                            file.path,
                                        );

                                        return (
                                            <div
                                                key={file.path}
                                                className="Box"
                                            >
                                                <div
                                                    className="Box-header file-header-container"
                                                    onClick={() =>
                                                        toggleFile(file.path)
                                                    }
                                                >
                                                    <div
                                                        className="d-flex flex-justify-between flex-items-center"
                                                        style={{
                                                            fontSize: "14px",
                                                        }}
                                                    >
                                                        <div className="d-flex flex-items-center">
                                                            <span className="text-mono text-bold mr-2">
                                                                {file.path}
                                                            </span>
                                                            <span
                                                                className={`Label Label--${statusInfo.color} mr-2`}
                                                            >
                                                                {
                                                                    statusInfo.label
                                                                }
                                                            </span>
                                                            <span className="color-fg-success mr-2">
                                                                +
                                                                {file.additions}
                                                            </span>
                                                            <span className="color-fg-danger">
                                                                -
                                                                {file.deletions}
                                                            </span>
                                                        </div>
                                                        <div className="d-flex flex-items-center">
                                                            <input
                                                                type="checkbox"
                                                                className="form-checkbox mr-2"
                                                                checked={
                                                                    file.viewed
                                                                }
                                                                onChange={(
                                                                    e,
                                                                ) => {
                                                                    e.stopPropagation();
                                                                    toggleViewed(
                                                                        file.path,
                                                                        file.viewed,
                                                                    );
                                                                }}
                                                                onClick={(e) =>
                                                                    e.stopPropagation()
                                                                }
                                                            />
                                                            <span className="color-fg-muted">
                                                                Viewed
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {isExpanded && (
                                                    <div className="Box-body p-0">
                                                        {file.is_image ? (
                                                            <ImageDiff
                                                                baseUrl={file.image_base_url}
                                                                headUrl={file.image_head_url}
                                                                status={file.status}
                                                                patch={file.patch}
                                                            />
                                                        ) : (
                                                            <div className="file-diff-content">
                                                                {file.patch
                                                                    .split("\n")
                                                                    .filter(
                                                                        (
                                                                            line,
                                                                        ) => {
                                                                            // Filter out Git diff metadata lines
                                                                            return !(
                                                                                line.startsWith(
                                                                                    "diff --git",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "index ",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "--- ",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "+++ ",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "new file mode",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "old file mode",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "deleted file mode",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "@@",
                                                                                )
                                                                            );
                                                                        },
                                                                    )
                                                                    .map(
                                                                        (
                                                                            line,
                                                                            index,
                                                                        ) =>
                                                                            renderDiffLine(
                                                                                line,
                                                                                index,
                                                                                file.path,
                                                                                comments[
                                                                                    file
                                                                                        .path
                                                                                ],
                                                                            ),
                                                                    )}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        ) : uncommittedCount === 0 ? (
                            <div className="blankslate">
                                <h3 className="blankslate-heading">
                                    No changes
                                </h3>
                                <p>
                                    There are no differences between your
                                    current branch and main, and no uncommitted changes.
                                </p>
                            </div>
                        ) : null}

                        {/* Notes Panel Toggle Button */}
                        <button
                            className="notes-panel-toggle btn btn-primary"
                            onClick={() => setNotesPanelOpen(!notesPanelOpen)}
                            title="Toggle AI Agent Notes"
                        >
                            <span className="mr-1">AI Notes</span>
                            {activeNotesCount > 0 && (
                                <span className="Counter Counter--primary">
                                    {activeNotesCount}
                                </span>
                            )}
                        </button>

                        {/* Notes Panel */}
                        <div
                            className={`notes-panel ${notesPanelOpen ? "open" : ""}`}
                        >
                            <div className="d-flex flex-justify-between flex-items-center mb-3">
                                <h2 className="h3">AI Agent Notes</h2>
                                <button
                                    className="btn btn-sm"
                                    onClick={() => setNotesPanelOpen(false)}
                                >
                                    Close
                                </button>
                            </div>

                            {/* Filter Section */}
                            <div className="filter-section">
                                <div className="filter-row mb-2">
                                    <div>
                                        <label className="text-bold text-small d-block mb-1">
                                            Author
                                        </label>
                                        <select
                                            className="form-select"
                                            value={noteFilters.author}
                                            onChange={(e) =>
                                                setNoteFilters((prev) => ({
                                                    ...prev,
                                                    author: e.target.value,
                                                }))
                                            }
                                        >
                                            <option value="all">
                                                All Authors
                                            </option>
                                            {uniqueAuthors.map((author) => (
                                                <option
                                                    key={author}
                                                    value={author}
                                                >
                                                    {author}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="text-bold text-small d-block mb-1">
                                            Type
                                        </label>
                                        <select
                                            className="form-select"
                                            value={noteFilters.type}
                                            onChange={(e) =>
                                                setNoteFilters((prev) => ({
                                                    ...prev,
                                                    type: e.target.value,
                                                }))
                                            }
                                        >
                                            <option value="all">
                                                All Types
                                            </option>
                                            {uniqueTypes.map((type) => (
                                                <option key={type} value={type}>
                                                    {type}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="form-checkbox">
                                    <label>
                                        <input
                                            type="checkbox"
                                            checked={noteFilters.showDismissed}
                                            onChange={(e) =>
                                                setNoteFilters((prev) => ({
                                                    ...prev,
                                                    showDismissed:
                                                        e.target.checked,
                                                }))
                                            }
                                        />
                                        <span className="ml-1">
                                            Show dismissed notes
                                        </span>
                                    </label>
                                </div>
                            </div>

                            {/* Notes List */}
                            <div>
                                <div className="text-bold text-small mb-2">
                                    {filteredNotes.length} note
                                    {filteredNotes.length !== 1 ? "s" : ""}
                                </div>
                                {filteredNotes.length === 0 ? (
                                    <div className="blankslate">
                                        <p className="text-small">
                                            No notes found
                                        </p>
                                    </div>
                                ) : (
                                    filteredNotes.map((note) => (
                                        <div
                                            key={note.id}
                                            className={`note-item ${note.dismissed ? "dismissed" : ""}`}
                                            onClick={() => {
                                                // Scroll to the note in the diff view
                                                const filePath = note.file_path;
                                                setExpandedFiles((prev) => {
                                                    const next = new Set(prev);
                                                    next.add(filePath);
                                                    return next;
                                                });
                                                setNotesPanelOpen(false);
                                            }}
                                        >
                                            <div className="note-badges mb-2">
                                                <span
                                                    className={`note-badge ${note.author}`}
                                                >
                                                    {note.author}
                                                </span>
                                                {note.type && (
                                                    <span
                                                        className={`note-badge ${note.type}`}
                                                    >
                                                        {note.type}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="text-small text-bold mb-1">
                                                {note.file_path}
                                                {note.line_number &&
                                                    `:${note.line_number}`}
                                            </div>
                                            <div className="text-small color-fg-muted mb-1">
                                                {note.text.substring(0, 100)}
                                                {note.text.length > 100
                                                    ? "..."
                                                    : ""}
                                            </div>
                                            <div className="d-flex flex-justify-between flex-items-center">
                                                <div className="text-small color-fg-muted">
                                                    {new Date(
                                                        note.timestamp * 1000,
                                                    ).toLocaleString()}
                                                </div>
                                                {!note.dismissed && (
                                                    <button
                                                        className="btn btn-sm"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            dismissNote(
                                                                note.id,
                                                            );
                                                        }}
                                                    >
                                                        Dismiss
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
