<!doctype html>
<html
    lang="en"
    data-color-mode="auto"
    data-light-theme="light"
    data-dark-theme="dark"
>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guck - Git Diff Reviewer</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css"
        />
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
            id="hljs-light"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
            id="hljs-dark"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <style>
            /* GitHub Diff Colors - Light Mode */
            :root {
                --diffBlob-additionLine-bgColor: #dafbe1;
                --diffBlob-additionNum-bgColor: #aceebb;
                --diffBlob-additionWord-bgColor: #aceebb;
                --diffBlob-deletionLine-bgColor: #ffebe9;
                --diffBlob-deletionNum-bgColor: #ffcecb;
                --diffBlob-deletionWord-bgColor: #ffcecb;
                --diffBlob-addition-fgColor: #116329;
                --diffBlob-deletion-fgColor: #82071e;
            }

            /* GitHub Diff Colors - Dark Mode */
            [data-color-mode="dark"] {
                --diffBlob-additionLine-bgColor: #2ea04326;
                --diffBlob-additionNum-bgColor: #3fb9504d;
                --diffBlob-additionWord-bgColor: #2ea04366;
                --diffBlob-deletionLine-bgColor: #f851491a;
                --diffBlob-deletionNum-bgColor: #f851494d;
                --diffBlob-deletionWord-bgColor: #f8514966;
                --diffBlob-addition-fgColor: #3fb950;
                --diffBlob-deletion-fgColor: #f85149;
            }

            body {
                min-height: 100vh;
            }

            /* Hide/show highlight.js themes based on color mode - controlled via JS disabled attribute */
            /* We don't use display: none here because it doesn't stop the cascade */

            .file-diff-content {
                font-family:
                    ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas,
                    "Liberation Mono", monospace;
                font-size: 12px;
                line-height: 20px;
                overflow-x: auto;
            }

            .diff-line {
                display: flex;
                min-width: max-content;
            }

            .diff-line-number {
                width: 50px;
                min-width: 50px;
                padding: 0 10px;
                text-align: right;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                color: var(--fgColor-muted);
                flex-shrink: 0;
                border-right: 1px solid var(--borderColor-default);
            }

            .diff-line-content {
                flex: 1;
                padding: 0 10px;
                white-space: pre;
            }

            /* Addition (green) lines */
            .diff-line.addition {
                background-color: var(--diffBlob-additionLine-bgColor);
            }

            .diff-line.addition .diff-line-number {
                background-color: var(--diffBlob-additionNum-bgColor);
                color: var(--diffBlob-addition-fgColor);
            }

            .diff-line.addition .diff-line-content {
                color: var(--diffBlob-addition-fgColor);
            }

            /* Deletion (red) lines */
            .diff-line.deletion {
                background-color: var(--diffBlob-deletionLine-bgColor);
            }

            .diff-line.deletion .diff-line-number {
                background-color: var(--diffBlob-deletionNum-bgColor);
                color: var(--diffBlob-deletion-fgColor);
            }

            .diff-line.deletion .diff-line-content {
                color: var(--diffBlob-deletion-fgColor);
            }

            /* Context lines */
            .diff-line.context {
                background-color: transparent;
            }

            .diff-line.context .diff-line-number {
                background-color: transparent;
            }

            /* Word-level highlighting */
            .diff-word-add {
                background-color: var(--diffBlob-additionWord-bgColor);
                border-radius: 2px;
            }

            .diff-word-del {
                background-color: var(--diffBlob-deletionWord-bgColor);
                border-radius: 2px;
            }

            /* Remove the brightness filter hack as we now properly toggle themes */

            .file-header-container {
                cursor: pointer;
                user-select: none;
            }

            .file-header-container:hover {
                background-color: var(--bgColor-muted);
            }

            .counter-label {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .file-header-items {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
            }

            .file-header-items > * {
                padding-left: 8px !important;
            }

            .file-header-items > *:first-child {
                padding-left: 0 !important;
            }

            .diff-line-wrapper {
                position: relative;
                display: flex;
                min-width: max-content;
            }

            .diff-line-wrapper:hover .add-comment-btn {
                opacity: 1;
            }

            .add-comment-btn {
                position: relative;
                opacity: 0;
                transition: opacity 0.1s;
                width: 22px;
                height: 22px;
                border-radius: 50%;
                background-color: #0969da;
                color: white;
                flex-shrink: 0;
                margin-right: 10px;
                border: none;
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
            }

            .add-comment-btn:hover {
                background-color: #0860ca;
            }

            .comment-form {
                background-color: var(--bgColor-muted);
                border: 1px solid var(--borderColor-default);
                border-radius: 6px;
                margin: 8px 40px 8px 40px;
                padding: 16px;
            }

            .comment-display {
                background-color: var(--bgColor-muted);
                border: 1px solid var(--borderColor-default);
                border-radius: 6px;
                margin: 8px 40px 8px 40px;
                padding: 12px 16px;
            }

            .comment-form textarea {
                width: 100% !important;
                box-sizing: border-box;
            }

            /* Staging status badges */
            .staging-badge {
                display: inline-flex;
                align-items: center;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
            }

            .staging-badge.staged {
                background-color: #1a7f37;
                color: white;
            }

            .staging-badge.unstaged {
                background-color: #9a6700;
                color: white;
            }

            /* Uncommitted section styling */
            .uncommitted-section {
                border: 2px dashed var(--borderColor-default);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 24px;
                background-color: var(--bgColor-muted);
            }

            .uncommitted-section-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
            }

            .uncommitted-icon {
                width: 24px;
                height: 24px;
                color: #9a6700;
            }

            .filter-section {
                margin-bottom: 16px;
                padding-bottom: 16px;
                border-bottom: 1px solid var(--borderColor-default);
            }

            .filter-row {
                display: flex;
                gap: 12px;
                align-items: flex-end;
            }

            .filter-row > div {
                flex: 1;
            }

            /* File box styling improvements */
            .Box {
                border-radius: 12px !important;
                overflow: hidden;
                margin-bottom: 16px !important;
            }

            .Box-header {
                border-radius: 0 !important;
            }

            .Box-row:first-child {
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
            }

            .Box-row:last-child {
                border-bottom-left-radius: 12px;
                border-bottom-right-radius: 12px;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            function App() {
                const [status, setStatus] = useState(null);
                const [diff, setDiff] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [expandedFiles, setExpandedFiles] = useState(new Set());
                const [comments, setComments] = useState({});
                const [commentText, setCommentText] = useState({});
                const [activeCommentLine, setActiveCommentLine] =
                    useState(null);

                // Theme management
                const getInitialTheme = () => {
                    const stored = localStorage.getItem("guck-theme");
                    if (stored) return stored;
                    return window.matchMedia("(prefers-color-scheme: dark)")
                        .matches
                        ? "dark"
                        : "light";
                };

                const [theme, setTheme] = useState(getInitialTheme);

                useEffect(() => {
                    const html = document.documentElement;
                    html.setAttribute("data-color-mode", theme);
                    localStorage.setItem("guck-theme", theme);

                    // Correctly toggle highlight.js themes by enabling/disabling the stylesheets
                    const lightLink = document.getElementById('hljs-light');
                    const darkLink = document.getElementById('hljs-dark');
                    
                    if (lightLink && darkLink) {
                        if (theme === 'dark') {
                            lightLink.disabled = true;
                            darkLink.disabled = false;
                        } else {
                            lightLink.disabled = false;
                            darkLink.disabled = true;
                        }
                    }
                }, [theme]);

                const toggleTheme = () => {
                    setTheme((prev) => (prev === "dark" ? "light" : "dark"));
                };

                useEffect(() => {
                    loadData();
                }, []);

                function updateDocumentTitle(repoPath, remoteURL) {
                    let title = "Guck";

                    if (remoteURL) {
                        // Try to extract account/repo from remote URL
                        // Supports formats like:
                        // - https://github.com/account/repo.git
                        // - git@github.com:account/repo.git
                        // - https://github.com/account/repo
                        const match = remoteURL.match(
                            /[:/]([^/]+\/[^/]+?)(\.git)?$/,
                        );
                        if (match) {
                            title = match[1];
                        } else {
                            // Fallback to local repo name
                            title = repoPath.split("/").pop();
                        }
                    } else {
                        // No remote URL, use local repository name
                        title = repoPath.split("/").pop();
                    }

                    document.title = title;
                }

                async function loadData() {
                    try {
                        setLoading(true);
                        const [statusRes, diffRes, commentsResRes] =
                            await Promise.all([
                                fetch("/api/status"),
                                fetch("/api/diff"),
                                fetch("/api/comments"),

                        // Update document title with repository name
                        updateDocumentTitle(
                            diffData.repo_path,
                            diffData.remote_url,
                        );

                        // Group comments by file_path
                        const commentsByFile = {};
                        commentsData.forEach((comment) => {
                            if (!commentsByFile[comment.file_path]) {
                                commentsByFile[comment.file_path] = [];
                            }
                            commentsByFile[comment.file_path].push(comment);
                        });
                        setComments(commentsByFile);

                        setError(null);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                }

                async function toggleViewed(filePath, currentlyViewed) {
                    try {
                        const endpoint = currentlyViewed
                            ? "/api/unmark-viewed"
                            : "/api/mark-viewed";
                        const res = await fetch(endpoint, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ file_path: filePath }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to update viewed status");
                        }

                        setDiff((prev) => ({
                            ...prev,
                            files: prev.files.map((f) =>
                                f.path === filePath
                                    ? { ...f, viewed: !currentlyViewed }
                                    : f,
                            ),
                        }));

                        // Collapse the file when marking as viewed
                        if (!currentlyViewed) {
                            setExpandedFiles((prev) => {
                                const next = new Set(prev);
                                next.delete(filePath);
                                return next;
                            });
                        }
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function addComment(filePath, lineNumber = null, parentId = null) {
                    const key = parentId 
                        ? `reply:${parentId}` 
                        : (lineNumber !== null ? `${filePath}:${lineNumber}` : filePath);
                    const text = commentText[key];
                    if (!text || !text.trim()) return;

                    try {
                        const res = await fetch("/api/comments", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                file_path: filePath,
                                line_number: lineNumber,
                                text: text.trim(),
                                parent_id: parentId,
                                author: "human",
                            }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to add comment");
                        }

                        const newComment = await res.json();

                        setComments((prev) => ({
                            ...prev,
                            [filePath]: [...(prev[filePath] || []), newComment],
                        }));

                        setCommentText((prev) => ({
                            ...prev,
                            [key]: "",
                        }));

                        if (!parentId) {
                            setActiveCommentLine(null);
                        }
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function resolveComment(commentId) {
                    try {
                        const res = await fetch("/api/comments/resolve", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                comment_id: commentId,
                            }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to resolve comment");
                        }

                        // Update local state to mark comment as resolved
                        setComments((prev) => {
                            const updated = {};
                            for (const [
                                filePath,
                                fileComments,
                            ] of Object.entries(prev)) {
                                updated[filePath] = fileComments.map((c) =>
                                    c.id === commentId
                                        ? { ...c, resolved: true }
                                        : c,
                                );
                            }
                            return updated;
                        });
                    } catch (err) {
                        setError(err.message);
                    }
                }

                function toggleFile(filePath) {
                    setExpandedFiles((prev) => {
                        const next = new Set(prev);
                        if (next.has(filePath)) {
                            next.delete(filePath);
                        } else {
                            next.add(filePath);
                        }
                        return next;
                    });
                }

                function getLanguageFromPath(filePath) {
                    const ext = filePath.split(".").pop().toLowerCase();
                    const langMap = {
                        js: "javascript",
                        jsx: "javascript",
                        ts: "typescript",
                        tsx: "typescript",
                        rs: "rust",
                        py: "python",
                        go: "go",
                        json: "json",
                        yaml: "yaml",
                        yml: "yaml",
                        md: "markdown",
                        html: "xml",
                        css: "css",
                        sh: "bash",
                        bash: "bash",
                        rb: "ruby",
                        java: "java",
                        c: "c",
                        cpp: "cpp",
                        h: "c",
                        hpp: "cpp",
                    };
                    return langMap[ext] || "plaintext";
                }

                function renderDiffLine(line, index, filePath, fileComments) {
                    const prefix = line[0];
                    const content = line.slice(1);

                    let lineClass = "context";

                    if (prefix === "+") {
                        lineClass = "addition";
                    } else if (prefix === "-") {
                        lineClass = "deletion";
                    }

                    const lineNumber = index + 1;
                    const lineComments = (fileComments || []).filter(
                        (c) => c.line_number === lineNumber,
                    );
                    const commentKey = `${filePath}:${lineNumber}`;
                    const isCommentActive = activeCommentLine === commentKey;

                    // Apply syntax highlighting to all lines (context, additions, and deletions)
                    let displayContent = content;
                    if (window.hljs) {
                        const language = getLanguageFromPath(filePath);
                        try {
                            const result = hljs.highlight(content, {
                                language,
                                ignoreIllegals: true,
                            });
                            displayContent = result.value;
                        } catch (e) {
                            // Fallback to plain text
                            displayContent = content;
                        }
                    }

                    return (
                        <React.Fragment key={index}>
                            <div className="diff-line-wrapper">
                                <button
                                    className="add-comment-btn"
                                    onClick={() =>
                                        setActiveCommentLine(
                                            isCommentActive ? null : commentKey,
                                        )
                                    }
                                    title="Add a comment to this line"
                                >
                                    +
                                </button>
                                <div className={`diff-line ${lineClass}`}>
                                    <span className="diff-line-number">
                                        {lineNumber}
                                    </span>
                                    <span
                                        className="diff-line-content"
                                        dangerouslySetInnerHTML={{
                                            __html: displayContent,
                                        }}
                                    />
                                </div>
                            </div>

                            {lineComments
                                .filter((c) => !c.resolved && !c.parent_id)
                                .map((comment) => (
                                    <div key={comment.id} className="comment-container mb-2">
                                        {/* Root Comment */}
                                        <div className="comment-display">
                                            <div className="d-flex flex-justify-between flex-items-center mb-1">
                                                <div className="d-flex flex-items-center">
                                                    {comment.author && (
                                                        <span className={`Label Label--${comment.author === 'human' ? 'secondary' : 'accent'} mr-2`}>
                                                            {comment.author}
                                                        </span>
                                                    )}
                                                    <div className="text-small color-fg-muted">
                                                        {new Date(comment.timestamp * 1000).toLocaleString()}
                                                    </div>
                                                </div>
                                                <div className="d-flex gap-2">
                                                    <button 
                                                        className="btn btn-sm"
                                                        onClick={() => setActiveCommentLine(activeCommentLine === `reply:${comment.id}` ? null : `reply:${comment.id}`)}
                                                    >
                                                        Reply
                                                    </button>
                                                    <button
                                                        className="btn btn-sm"
                                                        onClick={() => resolveComment(comment.id)}
                                                    >
                                                        Resolve
                                                    </button>
                                                </div>
                                            </div>
                                            <div>{comment.text}</div>
                                        </div>
                                        
                                        {/* Replies */}
                                        {lineComments.filter(r => r.parent_id === comment.id).map(reply => (
                                            <div key={reply.id} className="comment-display mt-2 ml-4" style={{borderLeft: "2px solid var(--color-accent-fg)"}}>
                                                <div className="d-flex flex-justify-between flex-items-center mb-1">
                                                    <div className="d-flex flex-items-center">
                                                        {reply.author && (
                                                            <span className={`Label Label--${reply.author === 'human' ? 'secondary' : 'accent'} mr-2`}>
                                                                {reply.author}
                                                            </span>
                                                        )}
                                                        <div className="text-small color-fg-muted">
                                                            {new Date(reply.timestamp * 1000).toLocaleString()}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>{reply.text}</div>
                                            </div>
                                        ))}

                                        {/* Reply Form */}
                                        {activeCommentLine === `reply:${comment.id}` && (
                                            <div className="comment-form mt-2">
                                                <textarea
                                                    className="form-control mb-2"
                                                    style={{ width: "100%" }}
                                                    placeholder="Reply..."
                                                    rows="2"
                                                    value={commentText[`reply:${comment.id}`] || ""}
                                                    onChange={(e) =>
                                                        setCommentText((prev) => ({
                                                            ...prev,
                                                            [`reply:${comment.id}`]: e.target.value,
                                                        }))
                                                    }
                                                    autoFocus
                                                />
                                                <div className="d-flex" style={{ gap: "8px" }}>
                                                    <button
                                                        className="btn btn-sm"
                                                        onClick={() => setActiveCommentLine(null)}
                                                    >
                                                        Cancel
                                                    </button>
                                                    <button
                                                        className="btn btn-primary btn-sm"
                                                        onClick={() => addComment(filePath, lineNumber, comment.id)}
                                                        disabled={!commentText[`reply:${comment.id}`]?.trim()}
                                                    >
                                                        Reply
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            {isCommentActive && (
                                <div className="comment-form">
                                    <div className="text-bold mb-2">
                                        Add a comment on line {lineNumber}
                                    </div>
                                    <textarea
                                        className="form-control mb-2"
                                        style={{ width: "100%" }}
                                        placeholder="Leave a comment"
                                        rows="3"
                                        value={commentText[commentKey] || ""}
                                        onChange={(e) =>
                                            setCommentText((prev) => ({
                                                ...prev,
                                                [commentKey]: e.target.value,
                                            }))
                                        }
                                        autoFocus
                                    />
                                    <div
                                        className="d-flex"
                                        style={{ gap: "8px" }}
                                    >
                                        <button
                                            className="btn btn-sm"
                                            onClick={() =>
                                                setActiveCommentLine(null)
                                            }
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            className="btn btn-primary btn-sm"
                                            onClick={() =>
                                                addComment(filePath, lineNumber)
                                            }
                                            disabled={
                                                !commentText[commentKey]?.trim()
                                            }
                                        >
                                            Comment
                                        </button>
                                    </div>
                                </div>
                            )}
                        </React.Fragment>
                    );
                }

                function getStatusLabel(status) {
                    const statusMap = {
                        added: { label: "Added", color: "success" },
                        modified: { label: "Modified", color: "attention" },
                        deleted: { label: "Deleted", color: "danger" },
                        renamed: { label: "Renamed", color: "accent" },
                    };
                    return (
                        statusMap[status] || { label: status, color: "default" }
                    );
                }

                if (loading) {
                    return (
                        <div className="container-lg p-4">
                            <div className="Subhead">
                                <h1 className="Subhead-heading">
                                    Loading diff...
                                </h1>
                            </div>
                        </div>
                    );
                }

                if (error) {
                    return (
                        <div className="container-lg p-4">
                            <div className="flash flash-error">
                                <strong>Error:</strong> {error}
                            </div>
                        </div>
                    );
                }

                const viewedCount =
                    diff?.files.filter((f) => f.viewed).length || 0;
                const totalCount = diff?.files.length || 0;
                const uncommittedCount = diff?.uncommitted_files?.length || 0;

                return (
                    <div className="container-lg p-2">
                        <div className="Subhead mb-5 d-flex flex-justify-between flex-items-center">
                            <div>
                                <div
                                    className="Subhead-heading d-flex flex-items-center"
                                    style={{ fontSize: "28px", gap: "12px" }}
                                >
                                    <a
                                        href="https://github.com/tuist/guck"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="Link--primary text-bold"
                                    >
                                        Guck
                                    </a>
                                </div>
                                <div className="Subhead-description mt-1">
                                    <span className="Label Label--secondary mr-2">
                                        Branch: {diff?.branch}
                                    </span>
                                    <span className="Label Label--secondary mr-2">
                                        Commit: {diff?.commit.slice(0, 7)}
                                    </span>
                                    <span className="color-fg-muted text-small">
                                        Â· A project by{" "}
                                        <a
                                            href="https://tuist.io"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="Link--primary"
                                        >
                                            Tuist
                                        </a>
                                    </span>
                                </div>
                            </div>
                            <button
                                className="btn btn-sm btn-invisible"
                                onClick={toggleTheme}
                                title="Toggle theme"
                                aria-label="Toggle theme"
                            >
                                {theme === "dark" ? (
                                    <svg
                                        className="octicon"
                                        width="16"
                                        height="16"
                                        viewBox="0 0 16 16"
                                        fill="currentColor"
                                    >
                                        <path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8Zm0-1.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Zm5.657-8.157a.75.75 0 0 1 0 1.061l-1.061 1.06a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734l1.06-1.06a.75.75 0 0 1 1.06 0Zm-9.193 9.193a.75.75 0 0 1 0 1.06l-1.06 1.061a.75.75 0 1 1-1.061-1.06l1.06-1.061a.75.75 0 0 1 1.061 0ZM8 0a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0ZM3 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 3 8Zm13 0a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5A.75.75 0 0 1 16 8Zm-8 5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 8 13Zm3.536-1.464a.75.75 0 0 1 1.06 0l1.061 1.06a.75.75 0 0 1-1.06 1.061l-1.061-1.06a.75.75 0 0 1 0-1.061ZM2.343 2.343a.75.75 0 0 1 1.061 0l1.06 1.061a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018l-1.06-1.06a.75.75 0 0 1 0-1.06Z"></path>
                                    </svg>
                                ) : (
                                    <svg
                                        className="octicon"
                                        width="16"
                                        height="16"
                                        viewBox="0 0 16 16"
                                        fill="currentColor"
                                    >
                                        <path d="M9.598 1.591a.749.749 0 0 1 .785-.175 7.001 7.001 0 1 1-8.967 8.967.75.75 0 0 1 .961-.96 5.5 5.5 0 0 0 7.046-7.046.75.75 0 0 1 .175-.786Zm1.616 1.945a7 7 0 0 1-7.678 7.678 5.499 5.499 0 1 0 7.678-7.678Z"></path>
                                    </svg>
                                )}
                            </button>
                        </div>

                        {/* Uncommitted Changes Section */}
                        {uncommittedCount > 0 && (
                            <div className="uncommitted-section">
                                <div className="uncommitted-section-header">
                                    <svg className="uncommitted-icon" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M5.75 1a.75.75 0 0 0-.75.75v3c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-3a.75.75 0 0 0-.75-.75h-4.5zm.75 3V2.5h3V4h-3zm-2.874-.467a.75.75 0 0 0-.752-1.298A7.81 7.81 0 0 0 0 8.25a7.81 7.81 0 0 0 2.874 6.015.75.75 0 1 0 .752-1.298A6.31 6.31 0 0 1 1.5 8.25a6.31 6.31 0 0 1 2.126-4.717zm8.248 0a.75.75 0 0 1 .752-1.298A7.81 7.81 0 0 1 16 8.25a7.81 7.81 0 0 1-2.874 6.015.75.75 0 1 1-.752-1.298A6.31 6.31 0 0 0 14.5 8.25a6.31 6.31 0 0 0-2.126-4.717zM8.75 9.5a.75.75 0 0 0-1.5 0v2.75a.75.75 0 0 0 1.5 0V9.5z"/>
                                    </svg>
                                    <div>
                                        <h3 className="h4 mb-0">Uncommitted Changes</h3>
                                        <span className="color-fg-muted text-small">
                                            {uncommittedCount} file{uncommittedCount !== 1 ? "s" : ""} with uncommitted changes
                                        </span>
                                    </div>
                                </div>
                                <div className="d-flex flex-column gap-3">
                                    {diff.uncommitted_files.map((file) => {
                                        const statusInfo = getStatusLabel(file.status);
                                        const fileKey = `uncommitted:${file.path}:${file.staging_status}`;
                                        const isExpanded = expandedFiles.has(fileKey);

                                        return (
                                            <div key={fileKey} className="Box">
                                                <div
                                                    className="Box-header file-header-container"
                                                    onClick={() => toggleFile(fileKey)}
                                                >
                                                    <div
                                                        className="d-flex flex-justify-between flex-items-center"
                                                        style={{ fontSize: "14px" }}
                                                    >
                                                        <div className="d-flex flex-items-center">
                                                            <span className="text-mono text-bold mr-2">
                                                                {file.path}
                                                            </span>
                                                            <span className={`staging-badge ${file.staging_status} mr-2`}>
                                                                {file.staging_status}
                                                            </span>
                                                            <span className={`Label Label--${statusInfo.color} mr-2`}>
                                                                {statusInfo.label}
                                                            </span>
                                                            <span className="color-fg-success mr-2">
                                                                +{file.additions}
                                                            </span>
                                                            <span className="color-fg-danger">
                                                                -{file.deletions}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {isExpanded && (
                                                    <div className="Box-body p-0">
                                                        <div className="file-diff-content">
                                                            {file.patch
                                                                .split("\n")
                                                                .filter((line) => {
                                                                    return !(
                                                                        line.startsWith("diff --git") ||
                                                                        line.startsWith("index ") ||
                                                                        line.startsWith("--- ") ||
                                                                        line.startsWith("+++ ") ||
                                                                        line.startsWith("new file mode") ||
                                                                        line.startsWith("old file mode") ||
                                                                        line.startsWith("deleted file mode") ||
                                                                        line.startsWith("@@")
                                                                    );
                                                                })
                                                                .map((line, index) =>
                                                                    renderDiffLine(line, index, file.path, comments[file.path] || [])
                                                                )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {diff && diff.files.length > 0 ? (
                            <>
                                <div className="Box mb-3">
                                    <div
                                        className="Box-row d-flex flex-justify-between flex-items-center"
                                        style={{ fontSize: "14px" }}
                                    >
                                        <div
                                            style={{
                                                display: "flex",
                                                alignItems: "center",
                                                gap: "8px",
                                            }}
                                        >
                                            <span>
                                                <strong>{totalCount}</strong>{" "}
                                                committed file
                                                {totalCount !== 1
                                                    ? "s"
                                                    : ""}{" "}
                                                changed
                                            </span>
                                            <span className="counter-label">
                                                <span className="Counter Counter--success">
                                                    {viewedCount}
                                                </span>
                                                <span
                                                    className="color-fg-muted"
                                                    style={{
                                                        marginLeft: "4px",
                                                    }}
                                                >
                                                    reviewed
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="d-flex flex-column gap-4">
                                    {diff.files.map((file) => {
                                        const statusInfo = getStatusLabel(
                                            file.status,
                                        );
                                        const isExpanded = expandedFiles.has(
                                            file.path,
                                        );

                                        return (
                                            <div
                                                key={file.path}
                                                className="Box"
                                            >
                                                <div
                                                    className="Box-header file-header-container"
                                                    onClick={() =>
                                                        toggleFile(file.path)
                                                    }
                                                >
                                                    <div
                                                        className="d-flex flex-justify-between flex-items-center"
                                                        style={{
                                                            fontSize: "14px",
                                                        }}
                                                    >
                                                        <div className="d-flex flex-items-center">
                                                            <span className="text-mono text-bold mr-2">
                                                                {file.path}
                                                            </span>
                                                            <span
                                                                className={`Label Label--${statusInfo.color} mr-2`}
                                                            >
                                                                {
                                                                    statusInfo.label
                                                                }
                                                            </span>
                                                            <span className="color-fg-success mr-2">
                                                                +
                                                                {file.additions}
                                                            </span>
                                                            <span className="color-fg-danger">
                                                                -
                                                                {file.deletions}
                                                            </span>
                                                        </div>
                                                        <div className="d-flex flex-items-center">
                                                            <input
                                                                type="checkbox"
                                                                className="form-checkbox mr-2"
                                                                checked={
                                                                    file.viewed
                                                                }
                                                                onChange={(
                                                                    e,
                                                                ) => {
                                                                    e.stopPropagation();
                                                                    toggleViewed(
                                                                        file.path,
                                                                        file.viewed,
                                                                    );
                                                                }}
                                                                onClick={(e) =>
                                                                    e.stopPropagation()
                                                                }
                                                            />
                                                            <span className="color-fg-muted">
                                                                Viewed
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {isExpanded && (
                                                    <>
                                                        <div className="Box-body p-0">
                                                            <div className="file-diff-content">
                                                                {file.patch
                                                                    .split("\n")
                                                                    .filter(
                                                                        (
                                                                            line,
                                                                        ) => {
                                                                            // Filter out Git diff metadata lines
                                                                            return !(
                                                                                line.startsWith(
                                                                                    "diff --git",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "index ",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "--- ",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "+++ ",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "new file mode",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "old file mode",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "deleted file mode",
                                                                                ) ||
                                                                                line.startsWith(
                                                                                    "@@",
                                                                                )
                                                                            );
                                                                        },
                                                                    )
                                                                    .map(
                                                                        (
                                                                            line,
                                                                            index,
                                                                        ) =>
                                                                            renderDiffLine(
                                                                                line,
                                                                                index,
                                                                                file.path,
                                                                                comments[
                                                                                    file
                                                                                        .path
                                                                                ],
                                                                            ),
                                                                    )}
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        ) : uncommittedCount === 0 ? (
                            <div className="blankslate">
                                <h3 className="blankslate-heading">
                                    No changes
                                </h3>
                                <p>
                                    There are no differences between your
                                    current branch and main, and no uncommitted changes.
                                </p>
                            </div>
                        ) : null}


                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
