<!doctype html>
<html lang="en" data-color-mode="dark" data-dark-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guck - Git Diff Reviewer</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css"
        />
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
        <style>
            body {
                background-color: #0d1117;
                min-height: 100vh;
            }

            .file-diff-content {
                font-family:
                    ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas,
                    "Liberation Mono", monospace;
                font-size: 12px;
                line-height: 20px;
                overflow-x: auto;
                padding-left: 32px;
                margin-left: -32px;
            }

            .diff-line {
                display: flex;
                width: 100%;
                min-width: max-content;
            }

            .diff-line-number {
                width: 40px;
                padding: 0 10px;
                text-align: right;
                user-select: none;
                color: #8b949e;
                flex-shrink: 0;
            }

            .diff-line-content {
                flex: 1;
                padding: 0 10px;
                white-space: pre;
                overflow-x: auto;
            }

            .diff-prefix {
                display: inline-block;
                width: 1ch;
                user-select: none;
            }

            .diff-line.addition {
                background-color: rgba(46, 160, 67, 0.15);
            }

            .diff-line.addition .diff-line-number {
                background-color: rgba(46, 160, 67, 0.15);
            }

            .diff-line.addition .diff-line-content {
                color: #c9d1d9;
            }

            .diff-line.deletion {
                background-color: rgba(248, 81, 73, 0.15);
            }

            .diff-line.deletion .diff-line-number {
                background-color: rgba(248, 81, 73, 0.15);
            }

            .diff-line.deletion .diff-line-content {
                color: #c9d1d9;
            }

            .diff-line.context {
                background-color: transparent;
            }

            .file-header-container {
                cursor: pointer;
                user-select: none;
            }

            .file-header-container:hover {
                background-color: #161b22;
            }

            .counter-label {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }

            .file-header-items {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
            }

            .file-header-items > * {
                padding-left: 8px !important;
            }

            .file-header-items > *:first-child {
                padding-left: 0 !important;
            }

            .diff-line-wrapper {
                position: relative;
                padding-left: 32px;
            }

            .diff-line-wrapper:hover .add-comment-btn {
                opacity: 1;
            }

            .add-comment-btn {
                position: absolute;
                left: -32px;
                top: 50%;
                transform: translateY(-50%);
                opacity: 0;
                transition: opacity 0.1s;
                width: 22px;
                height: 22px;
                border-radius: 50%;
                background-color: #0969da;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
            }

            .add-comment-btn:hover {
                background-color: #0860ca;
            }

            .comment-form {
                background-color: #161b22;
                border: 1px solid #30363d;
                border-radius: 6px;
                margin: 8px 40px 8px 40px;
                padding: 16px;
            }

            .comment-display {
                background-color: #161b22;
                border: 1px solid #30363d;
                border-radius: 6px;
                margin: 8px 40px 8px 40px;
                padding: 12px 16px;
            }

            [data-color-mode="light"] .comment-display {
                color: white;
            }

            [data-color-mode="light"] .comment-form {
                background-color: #ffffff;
                border: 1px solid #d0d7de;
            }

            .comment-form textarea {
                width: 100% !important;
                box-sizing: border-box;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            function App() {
                const [status, setStatus] = useState(null);
                const [diff, setDiff] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [expandedFiles, setExpandedFiles] = useState(new Set());
                const [comments, setComments] = useState({});
                const [commentText, setCommentText] = useState({});
                const [activeCommentLine, setActiveCommentLine] =
                    useState(null);

                useEffect(() => {
                    loadData();
                }, []);

                async function loadData() {
                    try {
                        setLoading(true);
                        const [statusRes, diffRes, commentsRes] =
                            await Promise.all([
                                fetch("/api/status"),
                                fetch("/api/diff"),
                                fetch("/api/comments"),
                            ]);

                        if (!statusRes.ok || !diffRes.ok || !commentsRes.ok) {
                            throw new Error("Failed to load data");
                        }

                        const statusData = await statusRes.json();
                        const diffData = await diffRes.json();
                        const commentsData = await commentsRes.json();

                        setStatus(statusData);
                        setDiff(diffData);

                        // Group comments by file_path
                        const commentsByFile = {};
                        commentsData.forEach((comment) => {
                            if (!commentsByFile[comment.file_path]) {
                                commentsByFile[comment.file_path] = [];
                            }
                            commentsByFile[comment.file_path].push(comment);
                        });
                        setComments(commentsByFile);

                        setError(null);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                }

                async function toggleViewed(filePath, currentlyViewed) {
                    try {
                        const endpoint = currentlyViewed
                            ? "/api/unmark-viewed"
                            : "/api/mark-viewed";
                        const res = await fetch(endpoint, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ file_path: filePath }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to update viewed status");
                        }

                        setDiff((prev) => ({
                            ...prev,
                            files: prev.files.map((f) =>
                                f.path === filePath
                                    ? { ...f, viewed: !currentlyViewed }
                                    : f,
                            ),
                        }));

                        // Collapse the file when marking as viewed
                        if (!currentlyViewed) {
                            setExpandedFiles((prev) => {
                                const next = new Set(prev);
                                next.delete(filePath);
                                return next;
                            });
                        }
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function addComment(filePath, lineNumber = null) {
                    const key =
                        lineNumber !== null
                            ? `${filePath}:${lineNumber}`
                            : filePath;
                    const text = commentText[key];
                    if (!text || !text.trim()) return;

                    try {
                        const res = await fetch("/api/comments", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                file_path: filePath,
                                line_number: lineNumber,
                                text: text.trim(),
                            }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to add comment");
                        }

                        const newComment = await res.json();

                        setComments((prev) => ({
                            ...prev,
                            [filePath]: [...(prev[filePath] || []), newComment],
                        }));

                        setCommentText((prev) => ({
                            ...prev,
                            [key]: "",
                        }));

                        setActiveCommentLine(null);
                    } catch (err) {
                        setError(err.message);
                    }
                }

                async function resolveComment(commentId) {
                    try {
                        const res = await fetch("/api/comments/resolve", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                comment_id: commentId,
                            }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to resolve comment");
                        }

                        // Update local state to mark comment as resolved
                        setComments((prev) => {
                            const updated = {};
                            for (const [
                                filePath,
                                fileComments,
                            ] of Object.entries(prev)) {
                                updated[filePath] = fileComments.map((c) =>
                                    c.id === commentId
                                        ? { ...c, resolved: true }
                                        : c,
                                );
                            }
                            return updated;
                        });
                    } catch (err) {
                        setError(err.message);
                    }
                }

                function toggleFile(filePath) {
                    setExpandedFiles((prev) => {
                        const next = new Set(prev);
                        if (next.has(filePath)) {
                            next.delete(filePath);
                        } else {
                            next.add(filePath);
                        }
                        return next;
                    });
                }

                function getLanguageFromPath(filePath) {
                    const ext = filePath.split(".").pop().toLowerCase();
                    const langMap = {
                        js: "javascript",
                        jsx: "jsx",
                        ts: "typescript",
                        tsx: "tsx",
                        rs: "rust",
                        py: "python",
                        json: "json",
                        yaml: "yaml",
                        yml: "yaml",
                        md: "markdown",
                        html: "markup",
                        css: "css",
                    };
                    return langMap[ext] || "javascript";
                }

                function renderDiffLine(line, index, filePath, fileComments) {
                    const prefix = line[0];
                    const content = line.slice(1);
                    let lineClass = "context";

                    if (prefix === "+") {
                        lineClass = "addition";
                    } else if (prefix === "-") {
                        lineClass = "deletion";
                    }

                    const lineNumber = index + 1;
                    const lineComments = (fileComments || []).filter(
                        (c) => c.line_number === lineNumber,
                    );
                    const commentKey = `${filePath}:${lineNumber}`;
                    const isCommentActive = activeCommentLine === commentKey;

                    // Syntax highlight the content
                    const language = getLanguageFromPath(filePath);
                    let highlightedContent = content;
                    try {
                        if (window.Prism && window.Prism.languages[language]) {
                            highlightedContent = Prism.highlight(
                                content,
                                Prism.languages[language],
                                language,
                            );
                        }
                    } catch (e) {
                        // Fallback to plain text if highlighting fails
                        highlightedContent = content;
                    }

                    // Add the prefix back to the highlighted content
                    const prefixSpan =
                        prefix !== " "
                            ? `<span class="diff-prefix">${prefix}</span>`
                            : '<span class="diff-prefix"> </span>';
                    const fullContent = prefixSpan + highlightedContent;

                    return (
                        <React.Fragment key={index}>
                            <div className="diff-line-wrapper">
                                <button
                                    className="add-comment-btn"
                                    onClick={() =>
                                        setActiveCommentLine(
                                            isCommentActive ? null : commentKey,
                                        )
                                    }
                                    title="Add a comment to this line"
                                >
                                    +
                                </button>
                                <div className={`diff-line ${lineClass}`}>
                                    <span className="diff-line-number">
                                        {lineNumber}
                                    </span>
                                    <span
                                        className="diff-line-content"
                                        dangerouslySetInnerHTML={{
                                            __html: fullContent,
                                        }}
                                    />
                                </div>
                            </div>
                            {lineComments
                                .filter((c) => !c.resolved)
                                .map((comment) => (
                                    <div
                                        key={comment.id}
                                        className="comment-display"
                                    >
                                        <div className="d-flex flex-justify-between flex-items-center mb-1">
                                            <div className="text-small color-fg-muted">
                                                {new Date(
                                                    comment.timestamp * 1000,
                                                ).toLocaleString()}
                                            </div>
                                            <button
                                                className="btn btn-sm"
                                                onClick={() =>
                                                    resolveComment(comment.id)
                                                }
                                            >
                                                Resolve
                                            </button>
                                        </div>
                                        <div>{comment.text}</div>
                                    </div>
                                ))}
                            {isCommentActive && (
                                <div className="comment-form">
                                    <div className="text-bold mb-2">
                                        Add a comment on line {lineNumber}
                                    </div>
                                    <textarea
                                        className="form-control mb-2"
                                        style={{ width: "100%" }}
                                        placeholder="Leave a comment"
                                        rows="3"
                                        value={commentText[commentKey] || ""}
                                        onChange={(e) =>
                                            setCommentText((prev) => ({
                                                ...prev,
                                                [commentKey]: e.target.value,
                                            }))
                                        }
                                        autoFocus
                                    />
                                    <div
                                        className="d-flex"
                                        style={{ gap: "8px" }}
                                    >
                                        <button
                                            className="btn btn-sm"
                                            onClick={() =>
                                                setActiveCommentLine(null)
                                            }
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            className="btn btn-primary btn-sm"
                                            onClick={() =>
                                                addComment(filePath, lineNumber)
                                            }
                                            disabled={
                                                !commentText[commentKey]?.trim()
                                            }
                                        >
                                            Comment
                                        </button>
                                    </div>
                                </div>
                            )}
                        </React.Fragment>
                    );
                }

                function getStatusLabel(status) {
                    const statusMap = {
                        added: { label: "Added", color: "success" },
                        modified: { label: "Modified", color: "attention" },
                        deleted: { label: "Deleted", color: "danger" },
                        renamed: { label: "Renamed", color: "accent" },
                    };
                    return (
                        statusMap[status] || { label: status, color: "default" }
                    );
                }

                if (loading) {
                    return (
                        <div className="container-lg p-4">
                            <div className="Subhead">
                                <h1 className="Subhead-heading">
                                    Loading diff...
                                </h1>
                            </div>
                        </div>
                    );
                }

                if (error) {
                    return (
                        <div className="container-lg p-4">
                            <div className="flash flash-error">
                                <strong>Error:</strong> {error}
                            </div>
                        </div>
                    );
                }

                const viewedCount =
                    diff?.files.filter((f) => f.viewed).length || 0;
                const totalCount = diff?.files.length || 0;

                return (
                    <div className="container-lg p-2">
                        <div className="Subhead mb-5">
                            <div
                                className="Subhead-heading"
                                style={{ fontSize: "28px" }}
                            >
                                <span className="text-bold">Guck</span>
                                <span className="text-normal ml-2">
                                    Diff Reviewer
                                </span>
                            </div>
                            <div className="Subhead-description mt-1">
                                <span className="Label Label--secondary mr-2">
                                    Branch: {diff?.branch}
                                </span>
                                <span className="Label Label--secondary">
                                    Commit: {diff?.commit.slice(0, 7)}
                                </span>
                            </div>
                        </div>

                        {diff && diff.files.length > 0 ? (
                            <>
                                <div className="Box mb-3">
                                    <div
                                        className="Box-row d-flex flex-justify-between flex-items-center"
                                        style={{ fontSize: "14px" }}
                                    >
                                        <div
                                            style={{
                                                display: "flex",
                                                alignItems: "center",
                                                gap: "8px",
                                            }}
                                        >
                                            <span>
                                                <strong>{totalCount}</strong>{" "}
                                                file
                                                {totalCount !== 1
                                                    ? "s"
                                                    : ""}{" "}
                                                changed
                                            </span>
                                            <span className="counter-label">
                                                <span className="Counter Counter--success">
                                                    {viewedCount}
                                                </span>
                                                <span
                                                    className="color-fg-muted"
                                                    style={{
                                                        marginLeft: "4px",
                                                    }}
                                                >
                                                    reviewed
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="d-flex flex-column gap-3">
                                    {diff.files.map((file) => {
                                        const statusInfo = getStatusLabel(
                                            file.status,
                                        );
                                        const isExpanded = expandedFiles.has(
                                            file.path,
                                        );

                                        return (
                                            <div
                                                key={file.path}
                                                className="Box"
                                            >
                                                <div
                                                    className="Box-header file-header-container"
                                                    onClick={() =>
                                                        toggleFile(file.path)
                                                    }
                                                >
                                                    <div
                                                        className="d-flex flex-justify-between flex-items-center"
                                                        style={{
                                                            fontSize: "14px",
                                                        }}
                                                    >
                                                        <div className="d-flex flex-items-center">
                                                            <span className="text-mono text-bold mr-2">
                                                                {file.path}
                                                            </span>
                                                            <span
                                                                className={`Label Label--${statusInfo.color} mr-2`}
                                                            >
                                                                {
                                                                    statusInfo.label
                                                                }
                                                            </span>
                                                            <span className="color-fg-success mr-2">
                                                                +
                                                                {file.additions}
                                                            </span>
                                                            <span className="color-fg-danger">
                                                                -
                                                                {file.deletions}
                                                            </span>
                                                        </div>
                                                        <div className="d-flex flex-items-center">
                                                            <input
                                                                type="checkbox"
                                                                className="form-checkbox mr-2"
                                                                checked={
                                                                    file.viewed
                                                                }
                                                                onChange={(
                                                                    e,
                                                                ) => {
                                                                    e.stopPropagation();
                                                                    toggleViewed(
                                                                        file.path,
                                                                        file.viewed,
                                                                    );
                                                                }}
                                                                onClick={(e) =>
                                                                    e.stopPropagation()
                                                                }
                                                            />
                                                            <span className="color-fg-muted">
                                                                Viewed
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {isExpanded && (
                                                    <>
                                                        <div className="Box-body p-0">
                                                            <div className="file-diff-content">
                                                                {file.patch
                                                                    .split("\n")
                                                                    .map(
                                                                        (
                                                                            line,
                                                                            index,
                                                                        ) =>
                                                                            renderDiffLine(
                                                                                line,
                                                                                index,
                                                                                file.path,
                                                                                comments[
                                                                                    file
                                                                                        .path
                                                                                ],
                                                                            ),
                                                                    )}
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        ) : (
                            <div className="blankslate">
                                <h3 className="blankslate-heading">
                                    No changes
                                </h3>
                                <p>
                                    There are no differences between your
                                    current branch and main.
                                </p>
                            </div>
                        )}
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
