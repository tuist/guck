<!doctype html>
<html lang="en" data-color-mode="dark" data-dark-theme="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guck - Git Diff Reviewer</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css"
        />
        <script
            crossorigin
            src="https://unpkg.com/react@18/umd/react.production.min.js"
        ></script>
        <script
            crossorigin
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
        ></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <style>
            body {
                background-color: #0d1117;
                min-height: 100vh;
            }

            .file-diff-content {
                font-family:
                    ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas,
                    "Liberation Mono", monospace;
                font-size: 12px;
                line-height: 20px;
            }

            .diff-line {
                display: flex;
                width: 100%;
            }

            .diff-line-number {
                width: 40px;
                padding: 0 10px;
                text-align: right;
                user-select: none;
                color: #8b949e;
                flex-shrink: 0;
            }

            .diff-line-content {
                flex: 1;
                padding: 0 10px;
                white-space: pre;
                overflow-x: auto;
            }

            .diff-line.addition {
                background-color: rgba(46, 160, 67, 0.15);
            }

            .diff-line.addition .diff-line-number {
                background-color: rgba(46, 160, 67, 0.15);
            }

            .diff-line.addition .diff-line-content {
                color: #c9d1d9;
            }

            .diff-line.deletion {
                background-color: rgba(248, 81, 73, 0.15);
            }

            .diff-line.deletion .diff-line-number {
                background-color: rgba(248, 81, 73, 0.15);
            }

            .diff-line.deletion .diff-line-content {
                color: #c9d1d9;
            }

            .diff-line.context {
                background-color: transparent;
            }

            .file-header-container {
                cursor: pointer;
                user-select: none;
            }

            .file-header-container:hover {
                background-color: #161b22;
            }

            .counter-label {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;

            function App() {
                const [status, setStatus] = useState(null);
                const [diff, setDiff] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [expandedFiles, setExpandedFiles] = useState(new Set());

                useEffect(() => {
                    loadData();
                }, []);

                async function loadData() {
                    try {
                        setLoading(true);
                        const [statusRes, diffRes] = await Promise.all([
                            fetch("/api/status"),
                            fetch("/api/diff"),
                        ]);

                        if (!statusRes.ok || !diffRes.ok) {
                            throw new Error("Failed to load data");
                        }

                        const statusData = await statusRes.json();
                        const diffData = await diffRes.json();

                        setStatus(statusData);
                        setDiff(diffData);
                        setError(null);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                }

                async function markAsViewed(filePath) {
                    try {
                        const res = await fetch("/api/mark-viewed", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ file_path: filePath }),
                        });

                        if (!res.ok) {
                            throw new Error("Failed to mark file as viewed");
                        }

                        setDiff((prev) => ({
                            ...prev,
                            files: prev.files.map((f) =>
                                f.path === filePath
                                    ? { ...f, viewed: true }
                                    : f,
                            ),
                        }));
                    } catch (err) {
                        setError(err.message);
                    }
                }

                function toggleFile(filePath) {
                    setExpandedFiles((prev) => {
                        const next = new Set(prev);
                        if (next.has(filePath)) {
                            next.delete(filePath);
                        } else {
                            next.add(filePath);
                        }
                        return next;
                    });
                }

                function renderDiffLine(line, index) {
                    const prefix = line[0];
                    const content = line.slice(1);
                    let lineClass = "context";

                    if (prefix === "+") {
                        lineClass = "addition";
                    } else if (prefix === "-") {
                        lineClass = "deletion";
                    }

                    return (
                        <div key={index} className={`diff-line ${lineClass}`}>
                            <span className="diff-line-number">
                                {index + 1}
                            </span>
                            <span className="diff-line-content">{content}</span>
                        </div>
                    );
                }

                function getStatusLabel(status) {
                    const statusMap = {
                        added: { label: "Added", color: "success" },
                        modified: { label: "Modified", color: "attention" },
                        deleted: { label: "Deleted", color: "danger" },
                        renamed: { label: "Renamed", color: "accent" },
                    };
                    return (
                        statusMap[status] || { label: status, color: "default" }
                    );
                }

                if (loading) {
                    return (
                        <div className="container-lg p-4">
                            <div className="Subhead">
                                <h1 className="Subhead-heading">
                                    Loading diff...
                                </h1>
                            </div>
                        </div>
                    );
                }

                if (error) {
                    return (
                        <div className="container-lg p-4">
                            <div className="flash flash-error">
                                <strong>Error:</strong> {error}
                            </div>
                        </div>
                    );
                }

                const viewedCount =
                    diff?.files.filter((f) => f.viewed).length || 0;
                const totalCount = diff?.files.length || 0;

                return (
                    <div className="container-lg p-4">
                        <div className="Subhead mb-4">
                            <div className="Subhead-heading">
                                <span className="text-bold">Guck</span>
                                <span className="text-normal ml-2">
                                    Diff Reviewer
                                </span>
                            </div>
                            <div className="Subhead-description mt-1">
                                <span className="Label Label--secondary mr-2">
                                    Branch: {diff?.branch}
                                </span>
                                <span className="Label Label--secondary">
                                    Commit: {diff?.commit.slice(0, 7)}
                                </span>
                            </div>
                        </div>

                        {diff && diff.files.length > 0 ? (
                            <>
                                <div className="Box mb-3">
                                    <div className="Box-row d-flex flex-justify-between flex-items-center">
                                        <div className="d-flex flex-items-center gap-3">
                                            <strong>{totalCount}</strong> file
                                            {totalCount !== 1 ? "s" : ""}{" "}
                                            changed
                                            <span className="counter-label">
                                                <span className="Counter Counter--success">
                                                    {viewedCount}
                                                </span>
                                                <span className="text-small color-fg-muted">
                                                    reviewed
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="d-flex flex-column gap-3">
                                    {diff.files.map((file) => {
                                        const statusInfo = getStatusLabel(
                                            file.status,
                                        );
                                        const isExpanded = expandedFiles.has(
                                            file.path,
                                        );

                                        return (
                                            <div
                                                key={file.path}
                                                className="Box"
                                            >
                                                <div
                                                    className="Box-header file-header-container"
                                                    onClick={() =>
                                                        toggleFile(file.path)
                                                    }
                                                >
                                                    <div className="d-flex flex-justify-between flex-items-center">
                                                        <div className="d-flex flex-items-center gap-2">
                                                            <span className="text-mono text-bold">
                                                                {file.path}
                                                            </span>
                                                            <span
                                                                className={`Label Label--${statusInfo.color}`}
                                                            >
                                                                {
                                                                    statusInfo.label
                                                                }
                                                            </span>
                                                            <span className="text-small color-fg-success">
                                                                +
                                                                {file.additions}
                                                            </span>
                                                            <span className="text-small color-fg-danger">
                                                                -
                                                                {file.deletions}
                                                            </span>
                                                        </div>
                                                        <div className="d-flex flex-items-center gap-2">
                                                            {file.viewed && (
                                                                <span className="Label Label--primary">
                                                                    âœ“ Viewed
                                                                </span>
                                                            )}
                                                            <button
                                                                className={`btn btn-sm ${file.viewed ? "btn-invisible" : "btn-primary"}`}
                                                                onClick={(
                                                                    e,
                                                                ) => {
                                                                    e.stopPropagation();
                                                                    markAsViewed(
                                                                        file.path,
                                                                    );
                                                                }}
                                                                disabled={
                                                                    file.viewed
                                                                }
                                                            >
                                                                {file.viewed
                                                                    ? "Viewed"
                                                                    : "Mark as viewed"}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {isExpanded && (
                                                    <div className="Box-body p-0">
                                                        <div className="file-diff-content">
                                                            {file.patch
                                                                .split("\n")
                                                                .map(
                                                                    (
                                                                        line,
                                                                        index,
                                                                    ) =>
                                                                        renderDiffLine(
                                                                            line,
                                                                            index,
                                                                        ),
                                                                )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        ) : (
                            <div className="blankslate">
                                <h3 className="blankslate-heading">
                                    No changes
                                </h3>
                                <p>
                                    There are no differences between your
                                    current branch and main.
                                </p>
                            </div>
                        )}
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        </script>
    </body>
</html>
